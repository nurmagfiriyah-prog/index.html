# index.html<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Happy Birthday Quest â€” Sofia ğŸ‚ (From Rona)</title>
  <style>
    :root{
      --bg1:#ffecf6;
      --bg2:#e9f6ff;
      --bg3:#fff6d9;
      --ink:#1b1b1f;
      --muted:#5a5a66;
      --card:rgba(255,255,255,.72);
      --card2:rgba(255,255,255,.9);
      --stroke:rgba(0,0,0,.08);
      --shadow: 0 18px 40px rgba(0,0,0,.10);
      --shadow2: 0 10px 22px rgba(0,0,0,.10);
      --r: 22px;
      --r2: 16px;
      --accent:#ff4fb3;
      --accent2:#6c63ff;
      --good:#2dd4bf;
      --warn:#fb7185;
      --gold:#fbbf24;
      --font: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      overflow-x:hidden;
      background:
        radial-gradient(1200px 800px at 15% 15%, var(--bg1), transparent 55%),
        radial-gradient(1100px 800px at 85% 20%, var(--bg2), transparent 60%),
        radial-gradient(900px 700px at 60% 90%, var(--bg3), transparent 60%),
        linear-gradient(180deg, #fff, #fff);
    }

    /* Floating hearts background */
    .bg-float{
      position:fixed; inset:0; pointer-events:none; overflow:hidden;
      z-index:0;
    }
    .float{
      position:absolute;
      font-size:22px;
      opacity:.22;
      animation: floatUp linear infinite;
      filter: blur(.2px);
    }
    @keyframes floatUp{
      from{ transform: translateY(110vh) translateX(0) rotate(0deg); }
      to{ transform: translateY(-20vh) translateX(40px) rotate(30deg); }
    }

    /* App layout */
    #app{position:relative; z-index:1; min-height:100%;}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: rgba(255,255,255,.55);
      border-bottom: 1px solid var(--stroke);
    }
    .topbar-inner{
      max-width: 980px;
      margin:0 auto;
      padding: 10px 14px;
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      letter-spacing:.2px;
      user-select:none;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.8);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      display:inline-flex; align-items:center; gap:6px;
      white-space:nowrap;
    }
    .pill{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.75);
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .right-tools{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}

    .btn{
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      border:none;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight:800;
      background: rgba(255,255,255,.85);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
      min-height:44px;
    }
    .btn:hover{filter:brightness(1.02)}
    .btn:active{transform: translateY(2px) scale(.99)}
    .btn.primary{
      background: linear-gradient(135deg, var(--accent), #ff8bd6);
      color:white;
      border: 1px solid rgba(255,255,255,.35);
    }
    .btn.secondary{
      background: linear-gradient(135deg, var(--accent2), #8a86ff);
      color:white;
      border: 1px solid rgba(255,255,255,.35);
    }
    .btn.good{
      background: linear-gradient(135deg, var(--good), #79f2dd);
      color:#052a23;
      border: 1px solid rgba(255,255,255,.35);
    }
    .btn.ghost{
      background: rgba(255,255,255,.6);
    }
    .btn.small{padding:10px 12px; border-radius:14px; font-size:13px; min-height:40px;}
    .btn.tiny{padding:8px 10px; border-radius:12px; font-size:12px; min-height:36px;}
    .btn.disabled{opacity:.5; pointer-events:none}

    .container{max-width:980px; margin:0 auto; padding: 18px 14px 60px;}
    .grid{display:grid; gap:14px;}
    .hero{
      display:grid;
      gap:14px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 820px){
      .hero{grid-template-columns: 1fr;}
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 16px;
      position:relative;
      overflow:hidden;
    }
    .card .shine{
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.75), transparent 40%);
      transform: rotate(12deg);
      opacity:.55;
      pointer-events:none;
    }
    .title{
      font-size: 28px;
      line-height: 1.15;
      margin:0 0 6px 0;
      font-weight: 950;
      letter-spacing:-.4px;
    }
    .subtitle{
      margin:0 0 12px 0;
      color:var(--muted);
      font-weight:700;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .spacer{height:10px}
    .muted{color:var(--muted)}
    .big-emoji{font-size:40px; filter: drop-shadow(0 8px 16px rgba(0,0,0,.12));}
    .mini{
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
    }
    .hr{
      height:1px; background: var(--stroke);
      margin: 12px 0;
    }

    /* Progress */
    .progress{
      height: 14px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.65);
      overflow:hidden;
      position:relative;
    }
    .progress > .bar{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .35s ease;
    }

    /* Scenes */
    .scene{display:none}
    .scene.active{display:block}

    /* Loading */
    .loading-wrap{
      min-height: calc(100vh - 60px);
      display:grid;
      place-items:center;
    }
    .loader{
      width:min(560px, 100%);
      text-align:center;
      padding: 22px;
    }
    .spinner{
      width: 84px; height:84px;
      margin: 0 auto 14px auto;
      border-radius:50%;
      border: 8px solid rgba(0,0,0,.06);
      border-top-color: var(--accent);
      border-right-color: var(--accent2);
      animation: spin 1.05s linear infinite;
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,.7);
    }
    @keyframes spin{to{transform: rotate(360deg)}}

    /* Tap ripple */
    .ripple{
      position:fixed;
      width:12px; height:12px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.95);
      transform: translate(-50%,-50%);
      pointer-events:none;
      animation: ripple .6s ease-out forwards;
      z-index: 9999;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
    }
    @keyframes ripple{
      from{opacity:.9; width:12px; height:12px;}
      to{opacity:0; width:120px; height:120px;}
    }
    .spark{
      position:fixed;
      transform: translate(-50%,-50%);
      pointer-events:none;
      z-index:9999;
      animation: spark 1.1s ease-out forwards;
      font-size:18px;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.18));
    }
    @keyframes spark{
      0%{opacity:1; transform: translate(-50%,-50%) scale(1)}
      100%{opacity:0; transform: translate(-50%,-80px) scale(1.35)}
    }

    /* Confetti canvas */
    #confetti{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:2000;
    }

    /* Map */
    .map-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    @media (max-width: 820px){
      .map-grid{grid-template-columns: repeat(2, 1fr);}
    }
    .level{
      background: rgba(255,255,255,.78);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 12px;
      box-shadow: var(--shadow2);
      cursor:pointer;
      min-height: 98px;
      display:flex; flex-direction:column; justify-content:space-between;
      transition: transform .12s ease, filter .12s ease;
      position:relative;
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
    }
    .level:hover{filter:brightness(1.02)}
    .level:active{transform: translateY(2px)}
    .level.locked{opacity:.55; cursor:not-allowed}
    .level .tag{
      font-size:12px; font-weight:900;
      display:inline-flex; gap:6px; align-items:center;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.8);
      width:max-content;
    }
    .level .name{
      font-weight:950;
      letter-spacing:-.2px;
      margin-top: 10px;
    }
    .level .desc{font-size:12px; color:var(--muted); font-weight:800}
    .level .corner{
      position:absolute; right:10px; top:10px;
      font-size:18px;
      opacity:.9;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      place-items:center;
      z-index:3000;
      background: rgba(10,10,20,.22);
      backdrop-filter: blur(10px);
      padding: 16px;
    }
    .modal.active{display:grid}
    .modal-card{
      width:min(860px, 100%);
      background: rgba(255,255,255,.86);
      border: 1px solid var(--stroke);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,255,255,.65);
    }
    .modal-title{
      font-weight:950;
      letter-spacing:-.2px;
      display:flex; gap:10px; align-items:center;
    }
    .modal-body{
      padding: 14px;
      max-height: 72vh;
      overflow:auto;
    }

    /* Game stage */
    .stage{
      background: rgba(255,255,255,.75);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: var(--shadow2);
      padding: 14px;
      min-height: 420px;
      position:relative;
      overflow:hidden;
    }
    .hud{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
      margin-bottom: 10px;
    }
    .hud-left,.hud-right{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.85);
      font-weight:900;
      font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
    }
    .hint{
      font-size:12px; font-weight:800; color:var(--muted);
      line-height:1.3;
    }
    .center{
      display:grid; place-items:center;
      min-height: 280px;
      text-align:center;
    }

    /* Common game elements */
    .bubble{
      position:absolute;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.88);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
      font-weight:950;
      cursor:pointer;
      min-height:44px;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .bubble:active{transform: translateY(2px) scale(.98)}
    .balloon{font-size:22px}
    .gift{font-size:22px}
    .heart{font-size:22px}

    /* Input */
    input[type="text"], input[type="range"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow2);
      font-weight:800;
      outline:none;
      min-height:44px;
    }

    /* Settings */
    .settings-grid{
      display:grid; grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width:820px){.settings-grid{grid-template-columns:1fr}}
    .setting{
      background: rgba(255,255,255,.78);
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding: 12px;
      box-shadow: var(--shadow2);
    }
    .setting h4{margin:0 0 8px 0}
    .setting .row{justify-content:space-between}

    /* Typewriter letter */
    .letter{
      background: rgba(255,255,255,.85);
      border:1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: var(--shadow2);
      padding: 14px;
      font-weight:800;
      line-height:1.55;
      white-space:pre-wrap;
      text-align:left;
    }

    /* Fireworks-ish */
    .glow{
      animation: glow 1.4s ease-in-out infinite alternate;
    }
    @keyframes glow{
      from{filter: drop-shadow(0 0 0 rgba(255,79,179,.0))}
      to{filter: drop-shadow(0 0 18px rgba(255,79,179,.45))}
    }

    /* Tiny helper */
    .k{font-weight:950}
    .link{
      cursor:pointer; font-weight:950; color:var(--accent2);
      text-decoration: underline;
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>

<body>
  <canvas id="confetti"></canvas>
  <div class="bg-float" id="bgFloat"></div>

  <div id="app">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <span class="big-emoji glow">ğŸ‚</span>
          <div>
            <div style="font-size:14px;font-weight:950;line-height:1.1">Happy Birthday Quest</div>
            <div class="mini">From <span class="k">Rona ğŸ‡®ğŸ‡©</span> â†’ To <span class="k">Sofia ğŸ‡ºğŸ‡¦</span></div>
          </div>
        </div>

        <div class="right-tools">
          <span class="badge" id="saveBadge">ğŸ’¾ Saved</span>
          <button class="btn tiny ghost" id="btnSettings">âš™ï¸ Settings</button>
          <button class="btn tiny ghost" id="btnSecretStar" title="Secret!">â­</button>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- SCENE: LOADING -->
      <section class="scene active" id="sceneLoading">
        <div class="loading-wrap">
          <div class="loader card">
            <div class="shine"></div>
            <div class="spinner"></div>
            <h1 class="title" id="loadingTitle">Loading surprises for Sofiaâ€¦</h1>
            <p class="subtitle" id="loadingSub">Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑÑÑ€Ğ¿Ñ€Ğ¸Ğ·Ñ–Ğ² Ğ´Ğ»Ñ Ğ¡Ğ¾Ñ„Ñ–Ñ—â€¦</p>
            <div class="progress" aria-label="loading progress">
              <div class="bar" id="loadingBar"></div>
            </div>
            <div class="spacer"></div>
            <div class="mini muted">Tip: tap anywhere for sparkles âœ¨</div>
          </div>
        </div>
      </section>

      <!-- SCENE: WELCOME -->
      <section class="scene" id="sceneWelcome">
        <div class="hero">
          <div class="card">
            <div class="shine"></div>
            <h1 class="title" id="welcomeTitle">Happy Birthday Quest ğŸ‚</h1>
            <p class="subtitle" id="welcomeSub">Made with love by Rona ğŸ’— / Ğ— Ğ»ÑĞ±Ğ¾Ğ²â€™Ñ Ğ²Ñ–Ğ´ Ğ Ğ¾Ğ½Ğ¸ ğŸ’—</p>

            <div class="row">
              <div class="pill">âœ¨ <span id="fairyName">Birthday Fairy</span>: <span id="fairyLine">â€œPsst! Tap everything!â€</span></div>
            </div>

            <div class="hr"></div>

            <label class="mini" id="labelName">Type your name (default Sofia)</label>
            <input type="text" id="inputName" value="Sofia" />

            <div class="spacer"></div>
            <div class="row">
              <button class="btn primary" id="btnStart">Start Birthday Quest ğŸ®</button>
              <button class="btn secondary" id="btnContinue">Continue ğŸ’¾</button>
              <button class="btn" id="btnReset">Reset</button>
            </div>

            <div class="spacer"></div>
            <div class="mini muted" id="welcomeHint">
              This is a gift-game full of surprises. Tap, click, explore, win! ğŸ
            </div>
          </div>

          <div class="card">
            <div class="shine"></div>
            <div class="center">
              <div>
                <div class="big-emoji">ğŸ§šâ€â™€ï¸âœ¨</div>
                <h2 style="margin:10px 0 6px 0; font-weight:950; letter-spacing:-.2px" id="sideTitle">Your Mission</h2>
                <p class="subtitle" style="margin:0" id="sideSub">
                  Beat the mini games to unlock the final surprise room ğŸ†
                </p>
                <div class="spacer"></div>
                <div class="row" style="justify-content:center">
                  <span class="badge">ğŸ® 12 mini games</span>
                  <span class="badge">ğŸ surprises</span>
                  <span class="badge">ğŸ’— bestie vibes</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SCENE: STORY -->
      <section class="scene" id="sceneStory">
        <div class="card">
          <div class="shine"></div>
          <h1 class="title" id="storyTitle">Cutscene: The Birthday Portal âœ¨</h1>
          <p class="subtitle" id="storySub">A tiny fairy appearsâ€¦</p>

          <div class="stage" id="storyStage">
            <div class="center">
              <div>
                <div class="big-emoji">ğŸ§šâ€â™€ï¸ğŸ€</div>
                <div class="spacer"></div>
                <div class="pill" style="max-width:720px; margin:0 auto;">
                  <span id="storyText">
                    â€œHello Sofia! Iâ€™m the Birthday Fairy. Rona filled this world with surprises just for you! 
                    Complete the mini games to unlock the Ultimate Gift Box!â€
                  </span>
                </div>
                <div class="spacer"></div>
                <div class="row" style="justify-content:center">
                  <button class="btn primary" id="btnToMap">Go to World Map ğŸ—ºï¸</button>
                  <button class="btn ghost" id="btnSkipStory">Skip</button>
                </div>
                <div class="spacer"></div>
                <div class="mini muted" id="storyHint">Tap the fairy for random quotes âœ¨</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SCENE: MAP -->
      <section class="scene" id="sceneMap">
        <div class="grid">
          <div class="card">
            <div class="shine"></div>
            <div class="row" style="justify-content:space-between">
              <div>
                <h1 class="title" style="margin-bottom:4px" id="mapTitle">World Map ğŸ—ºï¸</h1>
                <p class="subtitle" style="margin:0" id="mapSub">
                  Choose a level. Beat them all to unlock the final surprise room ğŸ†
                </p>
              </div>
              <div class="row">
                <span class="badge" id="badgeLang">ğŸŒ EN</span>
                <button class="btn small secondary" id="btnLang">Toggle Language</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row" style="justify-content:space-between">
              <div class="row">
                <span class="chip" id="chipCoins">ğŸª™ Coins: 0</span>
                <span class="chip" id="chipXP">âœ¨ XP: 0</span>
                <span class="chip" id="chipHearts">ğŸ’— Hearts: 3</span>
              </div>
              <div class="row">
                <button class="btn small" id="btnSpin">ğŸ¡ Lucky Spin</button>
                <button class="btn small ghost" id="btnToFinal">ğŸ Final Room</button>
              </div>
            </div>

            <div class="spacer"></div>
            <div class="progress" aria-label="quest progress">
              <div class="bar" id="questBar"></div>
            </div>
            <div class="spacer"></div>
            <div class="mini muted" id="progressText">Progress: 0/12 levels completed</div>
          </div>

          <div class="map-grid" id="mapGrid"></div>
        </div>
      </section>

      <!-- SCENE: FINAL -->
      <section class="scene" id="sceneFinal">
        <div class="card">
          <div class="shine"></div>
          <h1 class="title" id="finalTitle">Final Surprise Room ğŸ†</h1>
          <p class="subtitle" id="finalSub">Only unlocked after finishing all levels.</p>

          <div class="stage">
            <div class="center">
              <div>
                <div class="big-emoji glow" id="finalEmoji">ğŸ”’</div>
                <div class="spacer"></div>
                <div class="pill" style="max-width:780px;margin:0 auto">
                  <span id="finalText">
                    Finish all levels to open the Ultimate Gift Box ğŸ
                  </span>
                </div>
                <div class="spacer"></div>
                <div class="row" style="justify-content:center">
                  <button class="btn primary" id="btnOpenGift">Open Gift Box ğŸ</button>
                  <button class="btn ghost" id="btnBackMapFromFinal">Back to Map</button>
                </div>
                <div class="spacer"></div>
                <div class="row" style="justify-content:center">
                  <button class="btn secondary" id="btnOpenLetter">Open Secret Letter ğŸ’Œ</button>
                  <button class="btn" id="btnReplay">Replay All Games ğŸ®</button>
                </div>
              </div>
            </div>
          </div>

          <div class="spacer"></div>
          <div class="mini muted" id="finalHint">Tap the cake for confetti ğŸ‚âœ¨</div>
        </div>
      </section>
    </div>
  </div>

  <!-- MODAL: Settings -->
  <div class="modal" id="modalSettings">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title">âš™ï¸ Settings</div>
        <button class="btn tiny" id="btnCloseSettings">Close</button>
      </div>
      <div class="modal-body">
        <div class="settings-grid">
          <div class="setting">
            <h4>ğŸ”Š Sound</h4>
            <div class="row">
              <span class="mini muted">Click sounds + win sounds</span>
              <button class="btn small" id="btnSound">Sound: ON</button>
            </div>
          </div>
          <div class="setting">
            <h4>ğŸŒ Language</h4>
            <div class="row">
              <span class="mini muted">Toggle EN / UA</span>
              <button class="btn small secondary" id="btnLang2">Toggle</button>
            </div>
          </div>
          <div class="setting">
            <h4>ğŸ” Font Size</h4>
            <div class="row" style="gap:12px">
              <input type="range" id="fontSlider" min="90" max="120" value="100" />
              <span class="chip" id="fontVal">100%</span>
            </div>
          </div>
          <div class="setting">
            <h4>ğŸ’¾ Save</h4>
            <div class="row">
              <span class="mini muted">Auto-saves progress</span>
              <button class="btn small ghost" id="btnReset2">Reset Save</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="mini muted">
          Tip: Tap the â­ in the top bar for a secret room ğŸ˜­ğŸ’—
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Secret Room -->
  <div class="modal" id="modalSecret">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title">â­ Secret Room</div>
        <button class="btn tiny" id="btnCloseSecret">Close</button>
      </div>
      <div class="modal-body">
        <div class="card" style="background:rgba(255,255,255,.7)">
          <div class="shine"></div>
          <h2 style="margin:0 0 6px 0; font-weight:950">Secret Photo Frame (no photo) ğŸ–¼ï¸</h2>
          <p class="subtitle" style="margin:0 0 12px 0">
            Sofia, this frame is waiting for your cutest memory âœ¨
          </p>

          <div class="stage" style="min-height:240px; display:grid; place-items:center">
            <div style="width:min(520px,100%); aspect-ratio: 16/10; border-radius:26px; border:3px dashed rgba(0,0,0,.15); background:rgba(255,255,255,.6); display:grid; place-items:center; position:relative; overflow:hidden">
              <div class="big-emoji">ğŸ“¸ğŸ’—</div>
              <div style="position:absolute; bottom:10px; left:10px" class="badge">From Rona â†’ To Sofia</div>
              <div style="position:absolute; top:10px; right:10px" class="badge">Besties Forever âœ¨</div>
            </div>
          </div>

          <div class="spacer"></div>
          <div class="row" style="justify-content:center">
            <button class="btn primary" id="btnSecretConfetti">Make it sparkle âœ¨</button>
            <button class="btn secondary" id="btnSecretGift">Open tiny gift ğŸ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Game -->
  <div class="modal" id="modalGame">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="gameTitle">ğŸ® Level</div>
        <div class="row">
          <button class="btn tiny ghost" id="btnRetry">Retry</button>
          <button class="btn tiny" id="btnExit">Back to Map</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="hud">
          <div class="hud-left">
            <span class="chip" id="hudLevel">ğŸ—ºï¸ Level 1</span>
            <span class="chip" id="hudScore">â­ Score: 0</span>
            <span class="chip" id="hudTime">â³ Time: 0</span>
          </div>
          <div class="hud-right">
            <span class="chip" id="hudMsg">ğŸ§šâ€â™€ï¸ â€œTap everything!â€</span>
            <button class="btn tiny secondary" id="btnHint">?</button>
          </div>
        </div>

        <div class="hint" id="gameHint"></div>
        <div class="spacer"></div>
        <div class="stage" id="gameStage"></div>

        <div class="spacer"></div>
        <div class="row" style="justify-content:space-between">
          <button class="btn ghost" id="btnPrevLevel">â¬…ï¸ Prev</button>
          <div class="row">
            <button class="btn good" id="btnWinFake">âœ¨ Celebrate</button>
            <button class="btn primary" id="btnNextLevel">Next Level â¡ï¸</button>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="mini muted" id="tapTip">Tip: Tap/click anywhere for sparkles âœ¨</div>
      </div>
    </div>
  </div>

  <!-- MODAL: Letter -->
  <div class="modal" id="modalLetter">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title">ğŸ’Œ Secret Letter</div>
        <button class="btn tiny" id="btnCloseLetter">Close</button>
      </div>
      <div class="modal-body">
        <div class="letter" id="letterBox"></div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   HAPPY BIRTHDAY QUEST â€” Sofia (Ukraine) â€” From Rona (Indonesia)
   Single-file HTML + CSS + JS
   12 mini games + surprises + tap/click everywhere
   ========================================================= */

(() => {
  // ---------- Helpers ----------
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => [...el.querySelectorAll(q)];
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const rand = (a,b) => a + Math.random()*(b-a);
  const randi = (a,b) => Math.floor(rand(a,b+1));
  const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
  const now = () => performance.now();

  // ---------- Persistent state ----------
  const KEY = "sofia_birthday_quest_v1";
  const defaultState = {
    name: "Sofia",
    lang: "EN", // EN / UA
    sound: true,
    fontScale: 100,
    coins: 0,
    xp: 0,
    hearts: 3,
    unlocked: 1,
    completed: Array(12).fill(false),
    lastSeen: Date.now()
  };

  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return {...defaultState};
      const s = JSON.parse(raw);
      // merge
      return {...defaultState, ...s, completed: (s.completed && s.completed.length===12) ? s.completed : Array(12).fill(false)};
    }catch(e){
      return {...defaultState};
    }
  }
  function saveState(){
    state.lastSeen = Date.now();
    localStorage.setItem(KEY, JSON.stringify(state));
    flashSaveBadge();
  }
  function resetState(){
    state = {...defaultState};
    saveState();
    applyAllUI();
  }

  // ---------- UI elements ----------
  const scenes = {
    loading: $("#sceneLoading"),
    welcome: $("#sceneWelcome"),
    story: $("#sceneStory"),
    map: $("#sceneMap"),
    final: $("#sceneFinal")
  };
  const saveBadge = $("#saveBadge");

  function showScene(name){
    Object.values(scenes).forEach(s => s.classList.remove("active"));
    scenes[name].classList.add("active");
  }

  function flashSaveBadge(){
    saveBadge.textContent = "ğŸ’¾ Saved";
    saveBadge.style.transform = "scale(1.04)";
    setTimeout(()=> saveBadge.style.transform = "scale(1)", 180);
  }

  // ---------- Background floating emojis ----------
  const bgFloat = $("#bgFloat");
  function seedFloating(){
    bgFloat.innerHTML = "";
    const emojis = ["ğŸ’—","âœ¨","ğŸ‚","â­","ğŸ","ğŸŒ¸","ğŸ°","ğŸ§"];
    const count = 22;
    for(let i=0;i<count;i++){
      const d = document.createElement("div");
      d.className = "float";
      d.textContent = pick(emojis);
      d.style.left = rand(0,100)+"vw";
      d.style.animationDuration = rand(8,18)+"s";
      d.style.animationDelay = (-rand(0,18))+"s";
      d.style.fontSize = rand(18,34)+"px";
      bgFloat.appendChild(d);
    }
  }

  // ---------- Tap effects (ripple + sparkles) ----------
  const sparkEmojis = ["âœ¨","ğŸ’—","â­","ğŸŒ¸","ğŸ€","ğŸ«¶","ğŸ"];
  function tapFX(x,y){
    // ripple
    const r = document.createElement("div");
    r.className = "ripple";
    r.style.left = x+"px";
    r.style.top = y+"px";
    document.body.appendChild(r);
    setTimeout(()=> r.remove(), 650);

    // spark
    const s = document.createElement("div");
    s.className = "spark";
    s.textContent = pick(sparkEmojis);
    s.style.left = x+"px";
    s.style.top = y+"px";
    s.style.fontSize = rand(16,26)+"px";
    document.body.appendChild(s);
    setTimeout(()=> s.remove(), 1200);
  }

  // Pointer events everywhere
  window.addEventListener("pointerdown", (e)=>{
    // don't spam on sliders
    if(e.target && (e.target.tagName==="INPUT" && e.target.type==="range")) return;
    tapFX(e.clientX, e.clientY);
    sfx.click();
    // random micro surprise
    if(Math.random() < 0.04) popMessage();
  }, {passive:true});

  // ---------- Language strings ----------
  const T = {
    EN: {
      loadingTitle: "Loading surprises for Sofiaâ€¦",
      loadingSub: "Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑÑÑ€Ğ¿Ñ€Ğ¸Ğ·Ñ–Ğ² Ğ´Ğ»Ñ Ğ¡Ğ¾Ñ„Ñ–Ñ—â€¦",
      welcomeTitle: "Happy Birthday Quest ğŸ‚",
      welcomeSub: "Made with love by Rona ğŸ’— / Ğ— Ğ»ÑĞ±Ğ¾Ğ²â€™Ñ Ğ²Ñ–Ğ´ Ğ Ğ¾Ğ½Ğ¸ ğŸ’—",
      labelName: "Type your name (default Sofia)",
      start: "Start Birthday Quest ğŸ®",
      cont: "Continue ğŸ’¾",
      hintWelcome: "This is a gift-game full of surprises. Tap, click, explore, win! ğŸ",
      sideTitle: "Your Mission",
      sideSub: "Beat the mini games to unlock the final surprise room ğŸ†",
      storyTitle: "Cutscene: The Birthday Portal âœ¨",
      storySub: "A tiny fairy appearsâ€¦",
      storyText: (name)=>`â€œHello ${name}! Iâ€™m the Birthday Fairy. Rona filled this world with surprises just for you!
Complete the mini games to unlock the Ultimate Gift Box!â€`,
      storyHint: "Tap the fairy for random quotes âœ¨",
      mapTitle: "World Map ğŸ—ºï¸",
      mapSub: "Choose a level. Beat them all to unlock the final surprise room ğŸ†",
      progress: (c)=>`Progress: ${c}/12 levels completed`,
      finalTitle: "Final Surprise Room ğŸ†",
      finalSub: "Only unlocked after finishing all levels.",
      finalLocked: "Finish all levels to open the Ultimate Gift Box ğŸ",
      finalUnlocked: "YOU DID IT! The gift box is ready! ğŸâœ¨",
      openGift: "Open Gift Box ğŸ",
      openLetter: "Open Secret Letter ğŸ’Œ",
      replay: "Replay All Games ğŸ®",
      backMap: "Back to Map",
      tipFinal: "Tap the cake for confetti ğŸ‚âœ¨"
    },
    UA: {
      loadingTitle: "Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑÑÑ€Ğ¿Ñ€Ğ¸Ğ·Ñ–Ğ² Ğ´Ğ»Ñ Ğ¡Ğ¾Ñ„Ñ–Ñ—â€¦",
      loadingSub: "Loading surprises for Sofiaâ€¦",
      welcomeTitle: "ĞšĞ²ĞµÑÑ‚ Ğ”Ğ½Ñ ĞĞ°Ñ€Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ ğŸ‚",
      welcomeSub: "Ğ— Ğ»ÑĞ±Ğ¾Ğ²â€™Ñ Ğ²Ñ–Ğ´ Ğ Ğ¾Ğ½Ğ¸ ğŸ’— / Made with love by Rona ğŸ’—",
      labelName: "Ğ’Ğ²ĞµĞ´Ğ¸ Ñ–Ğ¼â€™Ñ (Ğ·Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ Sofia)",
      start: "ĞŸĞ¾Ñ‡Ğ°Ñ‚Ğ¸ Ğ¿Ñ€Ğ¸Ğ³Ğ¾Ğ´Ñƒ ğŸ®",
      cont: "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ²Ğ¶Ğ¸Ñ‚Ğ¸ ğŸ’¾",
      hintWelcome: "Ğ¦Ğµ Ğ¿Ğ¾Ğ´Ğ°Ñ€ÑƒĞ½Ğ¾Ğº-Ğ³Ñ€Ğ° Ğ· ĞºÑƒĞ¿Ğ¾Ñ ÑÑÑ€Ğ¿Ñ€Ğ¸Ğ·Ñ–Ğ². ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹, Ğ³Ñ€Ğ°Ğ¹, Ğ¿ĞµÑ€ĞµĞ¼Ğ°Ğ³Ğ°Ğ¹! ğŸ",
      sideTitle: "Ğ¢Ğ²Ğ¾Ñ Ğ¼Ñ–ÑÑ–Ñ",
      sideSub: "ĞŸÑ€Ğ¾Ğ¹Ğ´Ğ¸ Ğ¼Ñ–Ğ½Ñ–-Ñ–Ğ³Ñ€Ğ¸, Ñ‰Ğ¾Ğ± Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ñ„Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ñƒ ĞºÑ–Ğ¼Ğ½Ğ°Ñ‚Ñƒ ÑÑÑ€Ğ¿Ñ€Ğ¸Ğ·Ñ–Ğ² ğŸ†",
      storyTitle: "ĞšĞ°Ñ‚-ÑÑ†ĞµĞ½Ğ°: ĞŸĞ¾Ñ€Ñ‚Ğ°Ğ» Ğ¡Ğ²ÑÑ‚Ğ° âœ¨",
      storySub: "Ğ—â€™ÑĞ²Ğ»ÑÑ”Ñ‚ÑŒÑÑ Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ° Ñ„ĞµÑâ€¦",
      storyText: (name)=>`â€œĞŸÑ€Ğ¸Ğ²Ñ–Ñ‚, ${name}! Ğ¯ Ğ¤ĞµÑ Ğ”Ğ½Ñ ĞĞ°Ñ€Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ. Ğ Ğ¾Ğ½Ğ° Ğ½Ğ°Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ»Ğ° Ñ†ĞµĞ¹ ÑĞ²Ñ–Ñ‚ ÑÑÑ€Ğ¿Ñ€Ğ¸Ğ·Ğ°Ğ¼Ğ¸ ÑĞ¿ĞµÑ†Ñ–Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ñ‚ĞµĞ±Ğµ!
ĞŸÑ€Ğ¾Ğ¹Ğ´Ğ¸ Ğ¼Ñ–Ğ½Ñ–-Ñ–Ğ³Ñ€Ğ¸, Ñ‰Ğ¾Ğ± Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ¡ÑƒĞ¿ĞµÑ€ ĞŸĞ¾Ğ´Ğ°Ñ€ÑƒĞ½Ğ¾Ğº!â€`,
      storyHint: "ĞĞ°Ñ‚Ğ¸ÑĞ½Ğ¸ Ğ½Ğ° Ñ„ĞµÑ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ¿Ğ°Ğ´ĞºĞ¾Ğ²Ğ¸Ñ… Ñ„Ñ€Ğ°Ğ· âœ¨",
      mapTitle: "ĞšĞ°Ñ€Ñ‚Ğ° Ğ¡Ğ²Ñ–Ñ‚Ñƒ ğŸ—ºï¸",
      mapSub: "ĞĞ±Ğ¸Ñ€Ğ°Ğ¹ Ñ€Ñ–Ğ²ĞµĞ½ÑŒ. ĞŸÑ€Ğ¾Ğ¹Ğ´Ğ¸ Ğ²ÑÑ– â€” Ñ– Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ”Ñˆ Ñ„Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ñƒ ĞºÑ–Ğ¼Ğ½Ğ°Ñ‚Ñƒ ğŸ†",
      progress: (c)=>`ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑ: ${c}/12 Ñ€Ñ–Ğ²Ğ½Ñ–Ğ² Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ¾`,
      finalTitle: "Ğ¤Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ° ĞšÑ–Ğ¼Ğ½Ğ°Ñ‚Ğ° Ğ¡ÑÑ€Ğ¿Ñ€Ğ¸Ğ·Ñ–Ğ² ğŸ†",
      finalSub: "Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ğ²Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ¿Ñ–ÑĞ»Ñ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ Ğ²ÑÑ–Ñ… Ñ€Ñ–Ğ²Ğ½Ñ–Ğ².",
      finalLocked: "ĞŸÑ€Ğ¾Ğ¹Ğ´Ğ¸ Ğ²ÑÑ– Ñ€Ñ–Ğ²Ğ½Ñ–, Ñ‰Ğ¾Ğ± Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ¡ÑƒĞ¿ĞµÑ€ ĞŸĞ¾Ğ´Ğ°Ñ€ÑƒĞ½Ğ¾Ğº ğŸ",
      finalUnlocked: "Ğ¢Ğ˜ Ğ—ĞœĞĞ“Ğ›Ğ! ĞŸĞ¾Ğ´Ğ°Ñ€ÑƒĞ½Ğ¾Ğº Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¹! ğŸâœ¨",
      openGift: "Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ ĞŸĞ¾Ğ´Ğ°Ñ€ÑƒĞ½Ğ¾Ğº ğŸ",
      openLetter: "Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ›Ğ¸ÑÑ‚ ğŸ’Œ",
      replay: "ĞŸĞµÑ€ĞµĞ³Ñ€Ğ°Ñ‚Ğ¸ Ğ²ÑÑ– Ñ–Ğ³Ñ€Ğ¸ ğŸ®",
      backMap: "ĞĞ°Ğ·Ğ°Ğ´ Ğ´Ğ¾ ĞºĞ°Ñ€Ñ‚Ğ¸",
      tipFinal: "ĞĞ°Ñ‚Ğ¸ÑĞ½Ğ¸ Ğ½Ğ° Ñ‚Ğ¾Ñ€Ñ‚ Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ„ĞµÑ‚Ñ– ğŸ‚âœ¨"
    }
  };

  // ---------- Sound (WebAudio) ----------
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  function beep(freq=660, dur=0.08, type="sine", vol=0.08){
    if(!state.sound) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t0);
    o.stop(t0 + dur);
  }
  const sfx = {
    click: ()=> beep(420, 0.03, "square", 0.04),
    win: ()=> { beep(880,0.08,"sine",0.09); setTimeout(()=>beep(1175,0.08,"sine",0.08),90); setTimeout(()=>beep(1568,0.12,"triangle",0.07),180); },
    lose: ()=> { beep(220,0.12,"sawtooth",0.06); setTimeout(()=>beep(160,0.12,"sawtooth",0.05),120); }
  };

  // ---------- Confetti ----------
  const confettiCanvas = $("#confetti");
  const cctx = confettiCanvas.getContext("2d");
  let confetti = [];
  let confettiRunning = false;

  function resizeCanvas(){
    confettiCanvas.width = window.innerWidth * devicePixelRatio;
    confettiCanvas.height = window.innerHeight * devicePixelRatio;
    confettiCanvas.style.width = window.innerWidth+"px";
    confettiCanvas.style.height = window.innerHeight+"px";
    cctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function burstConfetti(n=120){
    for(let i=0;i<n;i++){
      confetti.push({
        x: rand(0, window.innerWidth),
        y: rand(-20, window.innerHeight*0.3),
        vx: rand(-2.5, 2.5),
        vy: rand(1.5, 5.5),
        r: rand(3, 7),
        rot: rand(0, Math.PI*2),
        vr: rand(-0.2,0.2),
        life: rand(60, 120)
      });
    }
    if(!confettiRunning) runConfetti();
  }
  function runConfetti(){
    confettiRunning = true;
    function frame(){
      cctx.clearRect(0,0,window.innerWidth, window.innerHeight);
      confetti = confetti.filter(p => p.life-- > 0);
      for(const p of confetti){
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.02;
        p.rot += p.vr;
        // draw
        cctx.save();
        cctx.translate(p.x, p.y);
        cctx.rotate(p.rot);
        cctx.globalAlpha = clamp(p.life/120, 0, 1);
        cctx.fillStyle = `hsl(${(p.x+p.y)%360} 90% 60%)`;
        cctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        cctx.restore();
      }
      if(confetti.length>0){
        requestAnimationFrame(frame);
      }else{
        confettiRunning = false;
        cctx.clearRect(0,0,window.innerWidth, window.innerHeight);
      }
    }
    requestAnimationFrame(frame);
  }

  // ---------- Surprise pop messages ----------
  const popLinesEN = [
    "Sofia youâ€™re magical âœ¨",
    "Rona says: Iâ€™m proud of you ğŸ’—",
    "Secret sparkle unlocked â­",
    "Bestie energy +999 ğŸ«¶",
    "You found a hidden smile ğŸ˜­ğŸ’—",
    "Tap tap tap! Surprise! ğŸ"
  ];
  const popLinesUA = [
    "Ğ¡Ğ¾Ñ„Ñ–Ñ”, Ñ‚Ğ¸ Ğ½ĞµĞ¹Ğ¼Ğ¾Ğ²Ñ–Ñ€Ğ½Ğ° âœ¨",
    "Ğ Ğ¾Ğ½Ğ° ĞºĞ°Ğ¶Ğµ: Ñ Ğ¿Ğ¸ÑˆĞ°ÑÑÑ Ñ‚Ğ¾Ğ±Ğ¾Ñ ğŸ’—",
    "Ğ¡ĞµĞºÑ€ĞµÑ‚Ğ½Ñ– Ğ±Ğ»Ğ¸ÑĞºÑ–Ñ‚ĞºĞ¸ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¾ â­",
    "Ğ•Ğ½ĞµÑ€Ğ³Ñ–Ñ Ğ´Ñ€ÑƒĞ¶Ğ±Ğ¸ +999 ğŸ«¶",
    "Ğ¢Ğ¸ Ğ·Ğ½Ğ°Ğ¹ÑˆĞ»Ğ° Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ²Ğ°Ğ½Ñƒ ÑƒÑĞ¼Ñ–ÑˆĞºÑƒ ğŸ˜­ğŸ’—",
    "ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹! Ğ¡ÑÑ€Ğ¿Ñ€Ğ¸Ğ·! ğŸ"
  ];
  function popMessage(){
    const text = state.lang==="EN" ? pick(popLinesEN) : pick(popLinesUA);
    const d = document.createElement("div");
    d.className = "bubble";
    d.style.left = rand(8, 78)+"%";
    d.style.top = rand(10, 70)+"%";
    d.style.zIndex = 999;
    d.textContent = "ğŸ’¬ " + text;
    d.addEventListener("pointerdown", ()=>{
      burstConfetti(40);
      sfx.win();
      d.remove();
      addReward(3, 2);
    }, {passive:true});
    document.body.appendChild(d);
    setTimeout(()=> d.remove(), 3200);
  }

  // ---------- Apply UI / language ----------
  function applyAllUI(){
    document.documentElement.style.fontSize = (16 * state.fontScale/100) + "px";
    $("#fontSlider").value = state.fontScale;
    $("#fontVal").textContent = state.fontScale + "%";
    $("#btnSound").textContent = "Sound: " + (state.sound ? "ON" : "OFF");

    $("#inputName").value = state.name || "Sofia";

    // welcome / loading / story / map / final
    const t = T[state.lang];
    $("#loadingTitle").textContent = t.loadingTitle;
    $("#loadingSub").textContent = t.loadingSub;

    $("#welcomeTitle").textContent = t.welcomeTitle;
    $("#welcomeSub").textContent = t.welcomeSub;
    $("#labelName").textContent = t.labelName;
    $("#btnStart").textContent = t.start;
    $("#btnContinue").textContent = t.cont;
    $("#welcomeHint").textContent = t.hintWelcome;
    $("#sideTitle").textContent = t.sideTitle;
    $("#sideSub").textContent = t.sideSub;

    $("#storyTitle").textContent = t.storyTitle;
    $("#storySub").textContent = t.storySub;
    $("#storyText").textContent = t.storyText(state.name || "Sofia");
    $("#storyHint").textContent = t.storyHint;

    $("#mapTitle").textContent = t.mapTitle;
    $("#mapSub").textContent = t.mapSub;

    $("#finalTitle").textContent = t.finalTitle;
    $("#finalSub").textContent = t.finalSub;
    $("#btnBackMapFromFinal").textContent = t.backMap;
    $("#btnOpenGift").textContent = t.openGift;
    $("#btnOpenLetter").textContent = t.openLetter;
    $("#btnReplay").textContent = t.replay;
    $("#finalHint").textContent = t.tipFinal;

    $("#badgeLang").textContent = "ğŸŒ " + state.lang;
    $("#btnToFinal").classList.toggle("disabled", !isAllComplete());

    updateStatsUI();
    buildMap();
    updateFinalUI();
  }

  // ---------- Stats / rewards ----------
  function updateStatsUI(){
    $("#chipCoins").textContent = "ğŸª™ Coins: " + state.coins;
    $("#chipXP").textContent = "âœ¨ XP: " + state.xp;
    $("#chipHearts").textContent = "ğŸ’— Hearts: " + state.hearts;
    const c = state.completed.filter(Boolean).length;
    $("#questBar").style.width = (c/12*100).toFixed(1)+"%";
    $("#progressText").textContent = T[state.lang].progress(c);
  }
  function addReward(coins=0, xp=0){
    state.coins += coins;
    state.xp += xp;
    saveState();
    updateStatsUI();
  }
  function loseHeart(){
    state.hearts = Math.max(0, state.hearts - 1);
    saveState();
    updateStatsUI();
  }

  function isAllComplete(){
    return state.completed.every(Boolean);
  }

  // ---------- Levels definition ----------
  const levels = [
    { id:1, icon:"ğŸˆ", nameEN:"Balloon Pop", nameUA:"Ğ›Ğ¾Ğ¿Ğ°Ğ¹ ĞºÑƒĞ»ÑŒĞºĞ¸", descEN:"Pop 20 balloons!", descUA:"Ğ›Ğ¾Ğ¿Ğ½Ğ¸ 20 ĞºÑƒĞ»ÑŒĞ¾Ğº!" },
    { id:2, icon:"ğŸƒ", nameEN:"Memory Cards", nameUA:"ĞŸĞ°Ğ¼â€™ÑÑ‚ÑŒ", descEN:"Match all pairs", descUA:"Ğ—Ğ½Ğ°Ğ¹Ğ´Ğ¸ Ğ¿Ğ°Ñ€Ğ¸" },
    { id:3, icon:"ğŸ", nameEN:"Catch Gifts", nameUA:"Ğ›Ğ¾Ğ²Ğ¸ Ğ¿Ğ¾Ğ´Ğ°Ñ€ÑƒĞ½ĞºĞ¸", descEN:"Catch falling gifts", descUA:"Ğ›Ğ¾Ğ²Ğ¸ Ğ¿Ğ¾Ğ´Ğ°Ñ€ÑƒĞ½ĞºĞ¸" },
    { id:4, icon:"âŒ¨ï¸", nameEN:"Typing Love", nameUA:"Ğ”Ñ€ÑƒĞº Ğ»ÑĞ±Ğ¾Ğ²Ñ–", descEN:"Type the phrase", descUA:"ĞĞ°Ğ´Ñ€ÑƒĞºÑƒĞ¹ Ñ„Ñ€Ğ°Ğ·Ñƒ" },
    { id:5, icon:"ğŸ§©", nameEN:"Maze", nameUA:"Ğ›Ğ°Ğ±Ñ–Ñ€Ğ¸Ğ½Ñ‚", descEN:"Find the cake", descUA:"Ğ—Ğ½Ğ°Ğ¹Ğ´Ğ¸ Ñ‚Ğ¾Ñ€Ñ‚" },
    { id:6, icon:"ğŸ’", nameEN:"Bestie Quiz", nameUA:"ĞšĞ²Ñ–Ğ· Ğ´Ñ€ÑƒĞ¶Ğ±Ğ¸", descEN:"Answer 5 questions", descUA:"5 Ğ¿Ğ¸Ñ‚Ğ°Ğ½ÑŒ" },
    { id:7, icon:"â¤ï¸", nameEN:"Hidden Hearts", nameUA:"Ğ¡Ñ…Ğ¾Ğ²Ğ°Ğ½Ñ– ÑĞµÑ€Ñ†Ñ", descEN:"Find 10 hearts", descUA:"Ğ—Ğ½Ğ°Ğ¹Ğ´Ğ¸ 10 ÑĞµÑ€Ğ´ĞµÑ†ÑŒ" },
    { id:8, icon:"ğŸ¯", nameEN:"Whack-a-Cake", nameUA:"Ğ‘Ğ¸Ğ¹ Ñ‚Ğ¾Ñ€Ñ‚", descEN:"Tap fast!", descUA:"ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ ÑˆĞ²Ğ¸Ğ´ĞºĞ¾!" },
    { id:9, icon:"ğŸ°", nameEN:"Cake Puzzle", nameUA:"ĞŸĞ°Ğ·Ğ» Ñ‚Ğ¾Ñ€Ñ‚Ğ°", descEN:"Drag pieces", descUA:"ĞŸĞµÑ€ĞµÑ‚ÑĞ³Ğ½Ğ¸ Ñ‡Ğ°ÑÑ‚Ğ¸Ğ½Ğ¸" },
    { id:10, icon:"ğŸ˜ˆ", nameEN:"Boss Monster", nameUA:"Ğ‘Ğ¾Ñ Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€", descEN:"Save the cake!", descUA:"Ğ’Ñ€ÑÑ‚ÑƒĞ¹ Ñ‚Ğ¾Ñ€Ñ‚!" },
    { id:11, icon:"ğŸµ", nameEN:"Rhythm Tap", nameUA:"Ğ Ğ¸Ñ‚Ğ¼", descEN:"Tap on beat", descUA:"ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ Ğ² Ñ€Ğ¸Ñ‚Ğ¼" },
    { id:12, icon:"ğŸ", nameEN:"Candy Snake", nameUA:"Ğ—Ğ¼Ñ–Ğ¹ĞºĞ°", descEN:"Eat candies", descUA:"Ğ‡Ğ¶ Ñ†ÑƒĞºĞµÑ€ĞºĞ¸" }
  ];

  function buildMap(){
    const grid = $("#mapGrid");
    grid.innerHTML = "";
    levels.forEach((lv)=>{
      const d = document.createElement("div");
      d.className = "level";
      const locked = lv.id > state.unlocked;
      if(locked) d.classList.add("locked");
      const done = state.completed[lv.id-1];

      const name = state.lang==="EN" ? lv.nameEN : lv.nameUA;
      const desc = state.lang==="EN" ? lv.descEN : lv.descUA;

      d.innerHTML = `
        <div class="corner">${done ? "ğŸ†" : (locked ? "ğŸ”’" : "âœ¨")}</div>
        <div class="tag">${lv.icon} <span>Level ${lv.id}</span></div>
        <div class="name">${name}</div>
        <div class="desc">${desc}</div>
      `;
      d.addEventListener("pointerdown", ()=>{
        if(locked){ sfx.lose(); popMessage(); return; }
        openLevel(lv.id);
      }, {passive:true});
      grid.appendChild(d);
    });
  }

  // ---------- Loading animation ----------
  function runLoading(){
    showScene("loading");
    let p = 0;
    const bar = $("#loadingBar");
    const iv = setInterval(()=>{
      p += rand(4,9);
      if(p>=100){
        p=100;
        clearInterval(iv);
        burstConfetti(120);
        setTimeout(()=> showScene("welcome"), 450);
      }
      bar.style.width = p+"%";
    }, 120);
  }

  // ---------- Story interactions ----------
  const fairyQuotesEN = [
    "Tap everything! Even the background ğŸ˜­âœ¨",
    "Rona put extra love in this level ğŸ’—",
    "Youâ€™re the birthday champion Sofia ğŸ†",
    "Secret tip: Lucky Spin gives power-ups ğŸ¡",
    "If you lose, the fairy still loves you ğŸ«¶"
  ];
  const fairyQuotesUA = [
    "ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ Ğ½Ğ° Ğ²ÑĞµ! ĞĞ°Ğ²Ñ–Ñ‚ÑŒ Ğ½Ğ° Ñ„Ğ¾Ğ½ ğŸ˜­âœ¨",
    "Ğ Ğ¾Ğ½Ğ° Ğ´Ğ¾Ğ´Ğ°Ğ»Ğ° ÑÑĞ´Ğ¸ Ğ±Ğ°Ğ³Ğ°Ñ‚Ğ¾ Ğ»ÑĞ±Ğ¾Ğ²Ñ– ğŸ’—",
    "Ğ¢Ğ¸ Ñ‡ĞµĞ¼Ğ¿Ñ–Ğ¾Ğ½ĞºĞ° Ğ´Ğ½Ñ Ğ½Ğ°Ñ€Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ, Ğ¡Ğ¾Ñ„Ñ–Ñ” ğŸ†",
    "ĞŸĞ¾Ñ€Ğ°Ğ´Ğ°: ĞšĞ¾Ğ»ĞµÑĞ¾ ÑƒĞ´Ğ°Ñ‡Ñ– Ğ´Ğ°Ñ” Ğ±Ğ¾Ğ½ÑƒÑĞ¸ ğŸ¡",
    "ĞĞ°Ğ²Ñ–Ñ‚ÑŒ ÑĞºÑ‰Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ñ”Ñˆ â€” Ñ„ĞµÑ Ñ‚ĞµĞ±Ğµ Ğ»ÑĞ±Ğ¸Ñ‚ÑŒ ğŸ«¶"
  ];
  function setFairyLine(){
    $("#fairyLine").textContent = state.lang==="EN" ? pick(fairyQuotesEN) : pick(fairyQuotesUA);
    $("#fairyName").textContent = state.lang==="EN" ? "Birthday Fairy" : "Ğ¤ĞµÑ Ğ”Ğ½Ñ ĞĞ°Ñ€Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ";
  }

  // ---------- Settings modal ----------
  const modalSettings = $("#modalSettings");
  $("#btnSettings").addEventListener("pointerdown", ()=> modalSettings.classList.add("active"), {passive:true});
  $("#btnCloseSettings").addEventListener("pointerdown", ()=> modalSettings.classList.remove("active"), {passive:true});
  $("#btnReset2").addEventListener("pointerdown", ()=> { if(confirm("Reset saved progress?")) resetState(); }, {passive:true});
  $("#btnSound").addEventListener("pointerdown", ()=>{
    state.sound = !state.sound;
    saveState();
    applyAllUI();
    burstConfetti(30);
  }, {passive:true});
  $("#fontSlider").addEventListener("input", (e)=>{
    state.fontScale = parseInt(e.target.value,10);
    saveState();
    applyAllUI();
  });
  $("#btnLang2").addEventListener("pointerdown", ()=> toggleLang(), {passive:true});

  // ---------- Secret modal ----------
  const modalSecret = $("#modalSecret");
  $("#btnSecretStar").addEventListener("pointerdown", ()=>{
    modalSecret.classList.add("active");
    burstConfetti(90);
    addReward(10, 5);
  }, {passive:true});
  $("#btnCloseSecret").addEventListener("pointerdown", ()=> modalSecret.classList.remove("active"), {passive:true});
  $("#btnSecretConfetti").addEventListener("pointerdown", ()=>{
    burstConfetti(220);
    sfx.win();
    addReward(20, 10);
  }, {passive:true});
  $("#btnSecretGift").addEventListener("pointerdown", ()=>{
    sfx.win();
    burstConfetti(140);
    popMessage();
    addReward(30, 20);
    alert(state.lang==="EN" ? "Tiny gift: +30 coins +20 XP ğŸ’—" : "ĞœĞ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğ¹ Ğ¿Ğ¾Ğ´Ğ°Ñ€ÑƒĞ½Ğ¾Ğº: +30 Ğ¼Ğ¾Ğ½ĞµÑ‚ +20 XP ğŸ’—");
  }, {passive:true});

  // ---------- Welcome controls ----------
  $("#btnStart").addEventListener("pointerdown", ()=>{
    state.name = $("#inputName").value.trim() || "Sofia";
    state.hearts = Math.max(state.hearts, 3);
    saveState();
    applyAllUI();
    showScene("story");
    burstConfetti(120);
    setFairyLine();
  }, {passive:true});

  $("#btnContinue").addEventListener("pointerdown", ()=>{
    state.name = $("#inputName").value.trim() || state.name || "Sofia";
    saveState();
    applyAllUI();
    showScene("map");
    burstConfetti(60);
  }, {passive:true});

  $("#btnReset").addEventListener("pointerdown", ()=>{
    if(confirm("Reset everything?")){
      resetState();
      burstConfetti(60);
      showScene("welcome");
    }
  }, {passive:true});

  // ---------- Story buttons ----------
  $("#btnToMap").addEventListener("pointerdown", ()=>{
    showScene("map");
    burstConfetti(70);
  }, {passive:true});
  $("#btnSkipStory").addEventListener("pointerdown", ()=>{
    showScene("map");
  }, {passive:true});

  // Tap story stage for quotes
  $("#storyStage").addEventListener("pointerdown", ()=>{
    const q = state.lang==="EN" ? pick(fairyQuotesEN) : pick(fairyQuotesUA);
    $("#storyText").textContent = q;
    burstConfetti(30);
  }, {passive:true});

  // ---------- Map controls ----------
  $("#btnLang").addEventListener("pointerdown", ()=> toggleLang(), {passive:true});
  function toggleLang(){
    state.lang = (state.lang==="EN") ? "UA" : "EN";
    saveState();
    applyAllUI();
    setFairyLine();
  }

  // Lucky Spin
  $("#btnSpin").addEventListener("pointerdown", ()=>{
    const rewards = [
      {tEN:"Extra Time +5s", tUA:"Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ñ‡Ğ°Ñ +5Ñ", apply:()=> powerUp.extraTime+=5},
      {tEN:"Double Score x2", tUA:"ĞŸĞ¾Ğ´Ğ²Ñ–Ğ¹Ğ½Ñ– Ğ±Ğ°Ğ»Ğ¸ x2", apply:()=> powerUp.doubleScore=true},
      {tEN:"Slow Motion", tUA:"ĞŸĞ¾Ğ²Ñ–Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼", apply:()=> powerUp.slow=true},
      {tEN:"+25 Coins", tUA:"+25 Ğ¼Ğ¾Ğ½ĞµÑ‚", apply:()=> addReward(25,5)},
      {tEN:"+1 Heart", tUA:"+1 ÑĞµÑ€Ñ†Ğµ", apply:()=> {state.hearts=Math.min(5,state.hearts+1); saveState(); updateStatsUI();}}
    ];
    const r = pick(rewards);
    burstConfetti(120);
    sfx.win();
    alert((state.lang==="EN"? "Lucky Spin: " : "ĞšĞ¾Ğ»ĞµÑĞ¾ ÑƒĞ´Ğ°Ñ‡Ñ–: ") + (state.lang==="EN"? r.tEN : r.tUA));
    r.apply();
  }, {passive:true});

  $("#btnToFinal").addEventListener("pointerdown", ()=>{
    showScene("final");
    updateFinalUI();
  }, {passive:true});

  // ---------- Final room ----------
  $("#btnBackMapFromFinal").addEventListener("pointerdown", ()=> showScene("map"), {passive:true});
  $("#btnReplay").addEventListener("pointerdown", ()=>{
    if(confirm("Replay all games? This resets completed levels but keeps coins/xp.")){
      state.completed = Array(12).fill(false);
      state.unlocked = 1;
      saveState();
      applyAllUI();
      showScene("map");
    }
  }, {passive:true});

  $("#btnOpenGift").addEventListener("pointerdown", ()=>{
    if(!isAllComplete()){
      sfx.lose();
      alert(state.lang==="EN" ? "Finish all levels first ğŸ’—" : "Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ¿Ñ€Ğ¾Ğ¹Ğ´Ğ¸ Ğ²ÑÑ– Ñ€Ñ–Ğ²Ğ½Ñ– ğŸ’—");
      return;
    }
    burstConfetti(350);
    sfx.win();
    $("#finalEmoji").textContent = "ğŸâœ¨";
    $("#finalText").textContent = state.lang==="EN"
      ? `HAPPY BIRTHDAY ${state.name || "Sofia"}!!! ğŸ‚ğŸ’— From Rona: Youâ€™re my favorite bestie forever ğŸ«¶`
      : `Ğ— Ğ”ĞĞ•Ğœ ĞĞĞ ĞĞ”Ğ–Ğ•ĞĞĞ¯ ${state.name || "Sofia"}!!! ğŸ‚ğŸ’— Ğ’Ñ–Ğ´ Ğ Ğ¾Ğ½Ğ¸: Ñ‚Ğ¸ Ğ¼Ğ¾Ñ Ğ½Ğ°Ğ¹ĞºÑ€Ğ°Ñ‰Ğ° Ğ¿Ğ¾Ğ´Ñ€ÑƒĞ³Ğ° Ğ½Ğ°Ğ·Ğ°Ğ²Ğ¶Ğ´Ğ¸ ğŸ«¶`;
  }, {passive:true});

  $("#btnOpenLetter").addEventListener("pointerdown", ()=>{
    openLetter();
  }, {passive:true});

  // Tap final stage for confetti
  $("#sceneFinal .stage").addEventListener("pointerdown", ()=>{
    burstConfetti(80);
  }, {passive:true});

  function updateFinalUI(){
    if(isAllComplete()){
      $("#finalEmoji").textContent = "ğŸ‚ğŸ†";
      $("#finalText").textContent = T[state.lang].finalUnlocked;
      $("#btnOpenGift").classList.remove("disabled");
      burstConfetti(120);
    }else{
      $("#finalEmoji").textContent = "ğŸ”’";
      $("#finalText").textContent = T[state.lang].finalLocked;
      $("#btnOpenGift").classList.add("disabled");
    }
  }

  // ---------- Letter (typewriter) ----------
  const modalLetter = $("#modalLetter");
  $("#btnCloseLetter").addEventListener("pointerdown", ()=> modalLetter.classList.remove("active"), {passive:true});

  function letterText(){
    const name = state.name || "Sofia";
    return state.lang==="EN"
      ? `Dear ${name} ğŸ’—

Happy Birthday!!! ğŸ‚âœ¨

I just want you to knowâ€¦
You are one of the sweetest, strongest, and most special people Iâ€™ve ever met.
Even when life is hard, you still shine â€” and I admire you so much.

Thank you for being my bestie.
Thank you for your kindness.
Thank you for your laughs.
Thank you for being YOU.

I hope this year brings you:
ğŸŒ¸ happiness that feels soft and safe
â­ dreams that come true
ğŸ surprises that make you smile
ğŸ’— love and peace in your heart

And no matter the distanceâ€¦
Indonesia ğŸ‡®ğŸ‡© and Ukraine ğŸ‡ºğŸ‡¦ are connected by our friendship ğŸ«¶

With all love,
Rona ğŸ’—`
      : `Ğ”Ğ¾Ñ€Ğ¾Ğ³Ğ° ${name} ğŸ’—

Ğ— Ğ”Ğ½ĞµĞ¼ ĞĞ°Ñ€Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ!!! ğŸ‚âœ¨

Ğ¯ Ñ…Ğ¾Ñ‡Ñƒ, Ñ‰Ğ¾Ğ± Ñ‚Ğ¸ Ğ·Ğ½Ğ°Ğ»Ğ°â€¦
Ğ¢Ğ¸ Ğ¾Ğ´Ğ½Ğ° Ğ· Ğ½Ğ°Ğ¹Ğ¼Ğ¸Ğ»Ñ–ÑˆĞ¸Ñ…, Ğ½Ğ°Ğ¹ÑĞ¸Ğ»ÑŒĞ½Ñ–ÑˆĞ¸Ñ… Ñ– Ğ½Ğ°Ğ¹Ğ¾ÑĞ¾Ğ±Ğ»Ğ¸Ğ²Ñ–ÑˆĞ¸Ñ… Ğ»ÑĞ´ĞµĞ¹, ÑĞºĞ¸Ñ… Ñ Ğ·Ğ½Ğ°Ñ.
ĞĞ°Ğ²Ñ–Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ¸ Ğ²Ğ°Ğ¶ĞºĞ¾ â€” Ñ‚Ğ¸ Ğ²ÑĞµ Ğ¾Ğ´Ğ½Ğ¾ ÑÑÑ”Ñˆ. Ğ¯ Ğ´ÑƒĞ¶Ğµ Ñ‚Ğ¾Ğ±Ğ¾Ñ Ğ·Ğ°Ñ…Ğ¾Ğ¿Ğ»ÑÑÑÑ.

Ğ”ÑĞºÑƒÑ Ñ‚Ğ¾Ğ±Ñ– Ğ·Ğ° Ğ´Ñ€ÑƒĞ¶Ğ±Ñƒ.
Ğ”ÑĞºÑƒÑ Ğ·Ğ° Ğ´Ğ¾Ğ±Ñ€Ğ¾Ñ‚Ñƒ.
Ğ”ÑĞºÑƒÑ Ğ·Ğ° ÑĞ¼Ñ–Ñ….
Ğ”ÑĞºÑƒÑ, Ñ‰Ğ¾ Ñ‚Ğ¸ â€” Ñ†Ğµ Ñ‚Ğ¸.

Ğ¯ Ğ±Ğ°Ğ¶Ğ°Ñ Ñ‚Ğ¾Ğ±Ñ– Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ€Ğ¾ĞºÑƒ:
ğŸŒ¸ Ñ‰Ğ°ÑÑ‚Ñ, ÑĞºĞµ Ğ±ÑƒĞ´Ğµ Ğ½Ñ–Ğ¶Ğ½Ğ¸Ğ¼ Ñ– ÑĞ¿Ğ¾ĞºÑ–Ğ¹Ğ½Ğ¸Ğ¼
â­ Ğ¼Ñ€Ñ–Ğ¹, ÑĞºÑ– Ğ·Ğ´Ñ–Ğ¹ÑĞ½ÑÑÑ‚ÑŒÑÑ
ğŸ ÑÑÑ€Ğ¿Ñ€Ğ¸Ğ·Ñ–Ğ², ÑĞºÑ– Ğ·Ğ¼ÑƒÑˆÑƒÑÑ‚ÑŒ ÑƒÑĞ¼Ñ–Ñ…Ğ°Ñ‚Ğ¸ÑÑŒ
ğŸ’— Ğ»ÑĞ±Ğ¾Ğ²Ñ– Ñ‚Ğ° Ğ¼Ğ¸Ñ€Ñƒ Ğ² ÑĞµÑ€Ñ†Ñ–

Ğ† Ğ½ĞµĞ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ Ğ²Ñ–Ğ´ÑÑ‚Ğ°Ğ½Ñ–â€¦
Ğ†Ğ½Ğ´Ğ¾Ğ½ĞµĞ·Ñ–Ñ ğŸ‡®ğŸ‡© Ñ‚Ğ° Ğ£ĞºÑ€Ğ°Ñ—Ğ½Ğ° ğŸ‡ºğŸ‡¦ Ğ·â€™Ñ”Ğ´Ğ½Ğ°Ğ½Ñ– Ğ½Ğ°ÑˆĞ¾Ñ Ğ´Ñ€ÑƒĞ¶Ğ±Ğ¾Ñ ğŸ«¶

Ğ— Ğ»ÑĞ±Ğ¾Ğ²â€™Ñ,
Ğ Ğ¾Ğ½Ğ° ğŸ’—`;
  }

  function openLetter(){
    modalLetter.classList.add("active");
    const box = $("#letterBox");
    box.textContent = "";
    const text = letterText();
    let i = 0;
    sfx.win();
    burstConfetti(120);
    const timer = setInterval(()=>{
      box.textContent += text[i] || "";
      i++;
      if(i%9===0) beep(880,0.02,"sine",0.02);
      if(i >= text.length){
        clearInterval(timer);
      }
    }, 14);
  }

  // ---------- Game modal ----------
  const modalGame = $("#modalGame");
  const gameStage = $("#gameStage");
  const hud = {
    level: $("#hudLevel"),
    score: $("#hudScore"),
    time: $("#hudTime"),
    msg: $("#hudMsg"),
    title: $("#gameTitle"),
    hint: $("#gameHint")
  };

  $("#btnExit").addEventListener("pointerdown", ()=>{
    closeGame();
    showScene("map");
  }, {passive:true});
  $("#btnRetry").addEventListener("pointerdown", ()=> restartLevel(), {passive:true});
  $("#btnHint").addEventListener("pointerdown", ()=>{
    burstConfetti(30);
    popMessage();
  }, {passive:true});
  $("#btnWinFake").addEventListener("pointerdown", ()=>{
    burstConfetti(140);
    sfx.win();
  }, {passive:true});
  $("#btnNextLevel").addEventListener("pointerdown", ()=>{
    if(currentLevelId < 12) openLevel(currentLevelId+1);
    else { closeGame(); showScene("final"); updateFinalUI(); }
  }, {passive:true});
  $("#btnPrevLevel").addEventListener("pointerdown", ()=>{
    if(currentLevelId > 1) openLevel(currentLevelId-1);
  }, {passive:true});

  let currentLevelId = 1;
  let levelCleanup = ()=>{};
  let levelTimer = null;

  // powerups from Lucky Spin (reset after each level)
  let powerUp = { extraTime:0, doubleScore:false, slow:false };

  function openLevel(id){
    currentLevelId = id;
    modalGame.classList.add("active");
    startLevel(id);
  }
  function closeGame(){
    modalGame.classList.remove("active");
    clearInterval(levelTimer);
    levelTimer = null;
    try{ levelCleanup(); }catch(e){}
    levelCleanup = ()=>{};
    powerUp = { extraTime:0, doubleScore:false, slow:false };
  }
  function restartLevel(){
    startLevel(currentLevelId);
  }

  function setHUD({title, hint, score=0, time=0, msg=""}){
    const lv = levels[currentLevelId-1];
    const nm = state.lang==="EN" ? lv.nameEN : lv.nameUA;
    hud.title.textContent = `ğŸ® Level ${currentLevelId}: ${nm} ${lv.icon}`;
    hud.level.textContent = `ğŸ—ºï¸ Level ${currentLevelId}/12`;
    hud.score.textContent = `â­ Score: ${score}`;
    hud.time.textContent = `â³ Time: ${time}`;
    hud.msg.textContent = `ğŸ§šâ€â™€ï¸ â€œ${msg}â€`;
    hud.hint.textContent = hint;
  }

  function winLevel(extraCoins=20, extraXP=15){
    sfx.win();
    burstConfetti(220);
    // mark complete
    state.completed[currentLevelId-1] = true;
    state.unlocked = Math.max(state.unlocked, currentLevelId+1);
    addReward(extraCoins, extraXP);
    saveState();
    updateStatsUI();
    buildMap();
    updateFinalUI();
    // cute message
    const msg = state.lang==="EN"
      ? `LEVEL CLEARED! Sofia is unstoppable ğŸ’— (+${extraCoins} coins, +${extraXP} XP)`
      : `Ğ Ğ†Ğ’Ğ•ĞĞ¬ ĞŸĞ ĞĞ™Ğ”Ğ•ĞĞ! Ğ¡Ğ¾Ñ„Ñ–Ñ Ğ½ĞµĞ¿ĞµÑ€ĞµĞ¼Ğ¾Ğ¶Ğ½Ğ° ğŸ’— (+${extraCoins} Ğ¼Ğ¾Ğ½ĞµÑ‚, +${extraXP} XP)`;
    setTimeout(()=> alert(msg), 60);
  }

  function loseLevel(){
    sfx.lose();
    burstConfetti(40);
    loseHeart();
    const msg = state.lang==="EN"
      ? "Oops! Try again ğŸ’— The fairy still loves you ğŸ§šâ€â™€ï¸"
      : "ĞĞ¹! Ğ¡Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ñ‰Ğµ Ñ€Ğ°Ğ· ğŸ’— Ğ¤ĞµÑ Ñ‚ĞµĞ±Ğµ Ğ»ÑĞ±Ğ¸Ñ‚ÑŒ ğŸ§šâ€â™€ï¸";
    alert(msg);
  }

  // ---------- Level engine ----------
  function startLevel(id){
    clearInterval(levelTimer);
    levelTimer = null;
    try{ levelCleanup(); }catch(e){}
    levelCleanup = ()=>{};
    gameStage.innerHTML = "";

    // reset per level
    let score = 0;
    let timeLeft = 0;

    // helper to update score
    function addScore(n){
      const mult = powerUp.doubleScore ? 2 : 1;
      score += n * mult;
      hud.score.textContent = `â­ Score: ${score}`;
    }

    // helper countdown
    function startCountdown(seconds, onEnd){
      timeLeft = seconds + (powerUp.extraTime||0);
      hud.time.textContent = `â³ Time: ${timeLeft}`;
      const slow = powerUp.slow ? 1.4 : 1;
      levelTimer = setInterval(()=>{
        timeLeft--;
        hud.time.textContent = `â³ Time: ${timeLeft}`;
        if(timeLeft<=0){
          clearInterval(levelTimer);
          levelTimer = null;
          onEnd();
        }
      }, 1000*slow);
    }

    // random fairy msg
    const msg = state.lang==="EN" ? pick(fairyQuotesEN) : pick(fairyQuotesUA);

    // Run the correct mini game
    switch(id){
      case 1: game1_balloonPop(); break;
      case 2: game2_memory(); break;
      case 3: game3_catchGifts(); break;
      case 4: game4_typing(); break;
      case 5: game5_maze(); break;
      case 6: game6_quiz(); break;
      case 7: game7_hiddenHearts(); break;
      case 8: game8_whack(); break;
      case 9: game9_puzzle(); break;
      case 10: game10_boss(); break;
      case 11: game11_rhythm(); break;
      case 12: game12_snake(); break;
    }

    // ---------------- GAMES ----------------

    // 1) Balloon pop
    function game1_balloonPop(){
      const target = 20;
      let popped = 0;

      setHUD({
        hint: state.lang==="EN"
          ? "Pop 20 balloons before time runs out! Tap balloons ğŸˆ"
          : "Ğ›Ğ¾Ğ¿Ğ½Ğ¸ 20 ĞºÑƒĞ»ÑŒĞ¾Ğº Ğ´Ğ¾ ĞºÑ–Ğ½Ñ†Ñ Ñ‡Ğ°ÑÑƒ! ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ ğŸˆ",
        score, time: 0, msg
      });

      const info = document.createElement("div");
      info.className = "pill";
      info.style.position = "absolute";
      info.style.left = "12px";
      info.style.bottom = "12px";
      info.textContent = `ğŸˆ ${popped}/${target}`;
      gameStage.appendChild(info);

      startCountdown(25, ()=>{
        if(popped>=target) winLevel(25,18);
        else loseLevel();
      });

      function spawn(){
        const b = document.createElement("div");
        b.className = "bubble balloon";
        b.textContent = "ğŸˆ";
        b.style.left = rand(5, 88)+"%";
        b.style.top = rand(10, 80)+"%";
        b.addEventListener("pointerdown", ()=>{
          popped++;
          addScore(5);
          info.textContent = `ğŸˆ ${popped}/${target}`;
          burstConfetti(12);
          beep(740,0.04,"triangle",0.05);
          b.remove();
          if(popped>=target){
            clearInterval(spawnIv);
            if(levelTimer){ clearInterval(levelTimer); levelTimer=null; }
            winLevel(30,20);
          }
        }, {passive:true});
        gameStage.appendChild(b);
        setTimeout(()=> b.remove(), 2000);
      }

      const spawnIv = setInterval(spawn, powerUp.slow ? 520 : 420);
      levelCleanup = ()=> clearInterval(spawnIv);
    }

    // 2) Memory cards
    function game2_memory(){
      setHUD({
        hint: state.lang==="EN"
          ? "Match all pairs. Tap two cards to reveal ğŸƒ"
          : "Ğ—Ğ½Ğ°Ğ¹Ğ´Ğ¸ Ğ²ÑÑ– Ğ¿Ğ°Ñ€Ğ¸. ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ Ğ½Ğ° Ğ´Ğ²Ñ– ĞºĞ°Ñ€Ñ‚Ğ¸ ğŸƒ",
        score, time: 0, msg
      });

      const emojis = ["ğŸ‚","ğŸ’—","â­","ğŸ±","ğŸŒ¸","ğŸ"];
      const deck = [...emojis, ...emojis].sort(()=> Math.random()-0.5);

      const wrap = document.createElement("div");
      wrap.style.display = "grid";
      wrap.style.gridTemplateColumns = "repeat(4, 1fr)";
      wrap.style.gap = "10px";
      wrap.style.padding = "10px";
      wrap.style.maxWidth = "520px";
      wrap.style.margin = "0 auto";
      gameStage.appendChild(wrap);

      let first = null;
      let lock = false;
      let matched = 0;

      function card(i){
        const c = document.createElement("button");
        c.className = "btn";
        c.style.borderRadius = "18px";
        c.style.minHeight = "72px";
        c.style.fontSize = "26px";
        c.dataset.i = i;
        c.dataset.val = deck[i];
        c.textContent = "â”";
        c.addEventListener("pointerdown", ()=>{
          if(lock) return;
          if(c.classList.contains("done")) return;
          if(c === first) return;
          c.textContent = c.dataset.val;
          burstConfetti(6);
          beep(640,0.03,"sine",0.04);

          if(!first){
            first = c;
          }else{
            lock = true;
            const a = first.dataset.val;
            const b = c.dataset.val;
            if(a===b){
              matched++;
              addScore(10);
              first.classList.add("done");
              c.classList.add("done");
              first.style.background = "rgba(45,212,191,.22)";
              c.style.background = "rgba(45,212,191,.22)";
              first = null;
              lock = false;
              burstConfetti(40);
              sfx.click();
              if(matched===emojis.length){
                winLevel(35,25);
              }
            }else{
              setTimeout(()=>{
                first.textContent = "â”";
                c.textContent = "â”";
                first = null;
                lock = false;
              }, 520);
            }
          }
        }, {passive:true});
        return c;
      }

      for(let i=0;i<deck.length;i++) wrap.appendChild(card(i));
    }

    // 3) Catch falling gifts
    function game3_catchGifts(){
      setHUD({
        hint: state.lang==="EN"
          ? "Catch 12 gifts! Drag the basket or tap left/right buttons ğŸ"
          : "Ğ—Ğ»Ğ¾Ğ²Ğ¸ 12 Ğ¿Ğ¾Ğ´Ğ°Ñ€ÑƒĞ½ĞºÑ–Ğ²! ĞŸĞµÑ€ĞµÑ‚ÑĞ³ÑƒĞ¹ ĞºĞ¾ÑˆĞ¸Ğº Ğ°Ğ±Ğ¾ Ğ½Ğ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ğŸ",
        score, time: 0, msg
      });

      const target = 12;
      let caught = 0;

      const basket = document.createElement("div");
      basket.className = "bubble";
      basket.style.width = "90px";
      basket.style.height = "56px";
      basket.style.borderRadius = "22px";
      basket.style.left = "40%";
      basket.style.top = "78%";
      basket.style.fontSize = "24px";
      basket.textContent = "ğŸ§º";
      gameStage.appendChild(basket);

      const info = document.createElement("div");
      info.className = "pill";
      info.style.position="absolute";
      info.style.left="12px";
      info.style.bottom="12px";
      info.textContent = `ğŸ ${caught}/${target}`;
      gameStage.appendChild(info);

      // control buttons
      const controls = document.createElement("div");
      controls.style.position="absolute";
      controls.style.right="12px";
      controls.style.bottom="12px";
      controls.style.display="flex";
      controls.style.gap="10px";
      controls.innerHTML = `
        <button class="btn small">â¬…ï¸</button>
        <button class="btn small">â¡ï¸</button>
      `;
      gameStage.appendChild(controls);
      const [btnL, btnR] = controls.querySelectorAll("button");

      let bx = 40; // %
      function setBasket(){
        basket.style.left = bx+"%";
      }
      function move(dir){
        bx = clamp(bx + dir*5, 0, 85);
        setBasket();
      }
      btnL.addEventListener("pointerdown", ()=> move(-1), {passive:true});
      btnR.addEventListener("pointerdown", ()=> move(1), {passive:true});

      // drag
      let dragging = false;
      basket.addEventListener("pointerdown", ()=> dragging=true, {passive:true});
      window.addEventListener("pointerup", ()=> dragging=false, {passive:true});
      gameStage.addEventListener("pointermove", (e)=>{
        if(!dragging) return;
        const rect = gameStage.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        bx = clamp(x*100 - 5, 0, 85);
        setBasket();
      }, {passive:true});

      // keyboard optional
      function key(e){
        if(e.key==="ArrowLeft") move(-1);
        if(e.key==="ArrowRight") move(1);
      }
      window.addEventListener("keydown", key);

      startCountdown(28, ()=>{
        window.removeEventListener("keydown", key);
        if(caught>=target) winLevel(30,20);
        else loseLevel();
      });

      function spawnGift(){
        const g = document.createElement("div");
        g.className = "bubble gift";
        g.textContent = pick(["ğŸ","ğŸ§¸","ğŸ­","ğŸ§"]);
        g.style.left = rand(6, 88)+"%";
        g.style.top = "-10%";
        gameStage.appendChild(g);

        let y = -10;
        const speed = powerUp.slow ? rand(0.35,0.65) : rand(0.55,1.0);
        const fall = setInterval(()=>{
          y += speed*2.6;
          g.style.top = y+"%";
          // collision
          const gr = g.getBoundingClientRect();
          const br = basket.getBoundingClientRect();
          if(gr.bottom >= br.top && gr.left < br.right && gr.right > br.left && gr.bottom < br.bottom + 20){
            caught++;
            addScore(8);
            info.textContent = `ğŸ ${caught}/${target}`;
            burstConfetti(20);
            beep(900,0.04,"sine",0.05);
            g.remove();
            clearInterval(fall);
            if(caught>=target){
              if(levelTimer){ clearInterval(levelTimer); levelTimer=null; }
              winLevel(40,25);
            }
          }
          if(y>100){
            g.remove();
            clearInterval(fall);
          }
        }, 16);

        g.addEventListener("pointerdown", ()=>{
          // tap gift gives tiny points
          addScore(2);
          burstConfetti(8);
        }, {passive:true});
      }

      const iv = setInterval(spawnGift, powerUp.slow ? 950 : 700);
      levelCleanup = ()=>{
        clearInterval(iv);
        window.removeEventListener("keydown", key);
      };
    }

    // 4) Typing
    function game4_typing(){
      const phraseUA = "Ğ— Ğ”Ğ½ĞµĞ¼ ĞĞ°Ñ€Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ, Ğ¡Ğ¾Ñ„Ñ–Ñ”!";
      const phraseEN = "Happy Birthday, Sofia!";
      const target = state.lang==="EN" ? phraseEN : phraseUA;

      setHUD({
        hint: state.lang==="EN"
          ? `Type this phrase exactly: "${target}"`
          : `ĞĞ°Ğ´Ñ€ÑƒĞºÑƒĞ¹ Ñ„Ñ€Ğ°Ğ·Ñƒ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾: "${target}"`,
        score, time: 0, msg
      });

      const box = document.createElement("div");
      box.style.maxWidth = "720px";
      box.style.margin = "0 auto";
      box.innerHTML = `
        <div class="pill" style="justify-content:center; font-size:14px">
          <span>âŒ¨ï¸</span>
          <span style="font-weight:950">${target}</span>
        </div>
        <div class="spacer"></div>
        <input type="text" id="typeInput" placeholder="Type here..." />
        <div class="spacer"></div>
        <div class="row" style="justify-content:center">
          <button class="btn primary" id="btnCheck">Check âœ…</button>
          <button class="btn ghost" id="btnAuto">Auto-fill (cheat ğŸ˜­)</button>
        </div>
        <div class="spacer"></div>
        <div class="mini muted" id="typeRes"></div>
      `;
      gameStage.appendChild(box);

      const input = $("#typeInput", box);
      const res = $("#typeRes", box);
      const btnCheck = $("#btnCheck", box);
      const btnAuto = $("#btnAuto", box);

      const startT = now();
      startCountdown(35, ()=>{
        // time up
        if(input.value.trim() === target){
          winLevel(35,25);
        }else{
          loseLevel();
        }
      });

      btnAuto.addEventListener("pointerdown", ()=>{
        input.value = target;
        burstConfetti(80);
        addReward(5,2);
      }, {passive:true});

      btnCheck.addEventListener("pointerdown", ()=>{
        const typed = input.value.trim();
        const dt = (now()-startT)/1000;
        const ok = typed === target;
        if(ok){
          addScore(30);
          res.textContent = state.lang==="EN"
            ? `Perfect! Time: ${dt.toFixed(1)}s ğŸ’—`
            : `Ğ†Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾! Ğ§Ğ°Ñ: ${dt.toFixed(1)}Ñ ğŸ’—`;
          if(levelTimer){ clearInterval(levelTimer); levelTimer=null; }
          winLevel(45,30);
        }else{
          res.textContent = state.lang==="EN"
            ? `Not yet ğŸ˜­ keep going!`
            : `Ğ©Ğµ Ğ½Ñ– ğŸ˜­ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ²Ğ¶ÑƒĞ¹!`;
          burstConfetti(10);
          beep(200,0.06,"sawtooth",0.04);
        }
      }, {passive:true});
    }

    // 5) Maze
    function game5_maze(){
      setHUD({
        hint: state.lang==="EN"
          ? "Guide the kitty ğŸ± to the cake ğŸ‚. Tap arrows or use keyboard."
          : "ĞŸÑ€Ğ¾Ğ²ĞµĞ´Ğ¸ ĞºĞ¾Ñ‚Ğ¸ĞºĞ° ğŸ± Ğ´Ğ¾ Ñ‚Ğ¾Ñ€Ñ‚Ğ° ğŸ‚. ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ ÑÑ‚Ñ€Ñ–Ğ»ĞºĞ¸ Ğ°Ğ±Ğ¾ ĞºĞ»Ğ°Ğ²Ñ–ÑˆÑ–.",
        score, time: 0, msg
      });

      const size = 9;
      const grid = Array.from({length:size}, ()=> Array(size).fill(0));
      // walls
      const walls = [
        [1,1],[1,2],[1,3],[1,5],[1,6],
        [2,3],[2,5],
        [3,1],[3,2],[3,5],[3,7],
        [4,3],[4,7],
        [5,1],[5,2],[5,5],[5,6],
        [6,3],[6,4],[6,6],
        [7,1],[7,6]
      ];
      walls.forEach(([r,c])=> grid[r][c]=1);

      let pr=0, pc=0;
      const goal = {r:8,c:8};

      const wrap = document.createElement("div");
      wrap.style.display="grid";
      wrap.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
      wrap.style.gap="6px";
      wrap.style.maxWidth="520px";
      wrap.style.margin="0 auto";
      wrap.style.padding="10px";
      gameStage.appendChild(wrap);

      function draw(){
        wrap.innerHTML="";
        for(let r=0;r<size;r++){
          for(let c=0;c<size;c++){
            const cell = document.createElement("div");
            cell.style.aspectRatio="1/1";
            cell.style.borderRadius="14px";
            cell.style.display="grid";
            cell.style.placeItems="center";
            cell.style.fontWeight="950";
            cell.style.border="1px solid rgba(0,0,0,.08)";
            cell.style.background = grid[r][c]===1 ? "rgba(251,113,133,.18)" : "rgba(255,255,255,.72)";
            cell.textContent = "";
            if(r===goal.r && c===goal.c) cell.textContent="ğŸ‚";
            if(r===pr && c===pc) cell.textContent="ğŸ±";
            cell.addEventListener("pointerdown", ()=>{
              // tap cell = attempt move closer
              if(Math.abs(r-pr)+Math.abs(c-pc)===1) move(r-pr, c-pc);
            }, {passive:true});
            wrap.appendChild(cell);
          }
        }
      }

      function move(dr,dc){
        const nr = pr+dr, nc = pc+dc;
        if(nr<0||nc<0||nr>=size||nc>=size) return;
        if(grid[nr][nc]===1) { beep(160,0.06,"sawtooth",0.04); return; }
        pr=nr; pc=nc;
        addScore(1);
        burstConfetti(5);
        draw();
        if(pr===goal.r && pc===goal.c){
          winLevel(35,22);
        }
      }

      // controls
      const controls = document.createElement("div");
      controls.style.display="grid";
      controls.style.gridTemplateColumns="repeat(3, 1fr)";
      controls.style.gap="10px";
      controls.style.maxWidth="320px";
      controls.style.margin="12px auto 0 auto";
      controls.innerHTML = `
        <div></div><button class="btn small">â¬†ï¸</button><div></div>
        <button class="btn small">â¬…ï¸</button><button class="btn small">â¬‡ï¸</button><button class="btn small">â¡ï¸</button>
      `;
      gameStage.appendChild(controls);
      const btns = controls.querySelectorAll("button");
      btns[0].addEventListener("pointerdown", ()=> move(-1,0), {passive:true});
      btns[1].addEventListener("pointerdown", ()=> move(0,-1), {passive:true});
      btns[2].addEventListener("pointerdown", ()=> move(1,0), {passive:true});
      btns[3].addEventListener("pointerdown", ()=> move(0,1), {passive:true});

      function key(e){
        if(e.key==="ArrowUp") move(-1,0);
        if(e.key==="ArrowDown") move(1,0);
        if(e.key==="ArrowLeft") move(0,-1);
        if(e.key==="ArrowRight") move(0,1);
      }
      window.addEventListener("keydown", key);

      draw();
      levelCleanup = ()=> window.removeEventListener("keydown", key);
    }

    // 6) Quiz
    function game6_quiz(){
      setHUD({
        hint: state.lang==="EN"
          ? "Answer 5 friendship questions ğŸ’"
          : "Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ğ¹ Ğ½Ğ° 5 Ğ¿Ğ¸Ñ‚Ğ°Ğ½ÑŒ Ğ¿Ñ€Ğ¾ Ğ´Ñ€ÑƒĞ¶Ğ±Ñƒ ğŸ’",
        score, time: 0, msg
      });

      const qs = state.lang==="EN" ? [
        {q:"What is Sofiaâ€™s superpower?", a:["Being kind ğŸ’—","Being mean ğŸ˜ˆ","Stealing cakes ğŸ°"], ok:0},
        {q:"Ronaâ€™s message for Sofia isâ€¦", a:["Youâ€™re precious âœ¨","Go away ğŸ™„","No cake for you ğŸ˜­"], ok:0},
        {q:"Bestie rule #1:", a:["Support each other ğŸ«¶","Fight daily ğŸ¥Š","Ignore forever ğŸ§Š"], ok:0},
        {q:"When Sofia is sad, Rona willâ€¦", a:["Send love & hugs ğŸ’Œ","Laugh ğŸ˜­","Disappear ğŸ«¥"], ok:0},
        {q:"Friendship level:", a:["FOREVER â™¾ï¸","2 minutes â³","Only on Mondays ğŸ¥²"], ok:0},
      ] : [
        {q:"Ğ¯ĞºĞ° ÑÑƒĞ¿ĞµÑ€ÑĞ¸Ğ»Ğ° Ñƒ Ğ¡Ğ¾Ñ„Ñ–Ñ—?", a:["Ğ”Ğ¾Ğ±Ñ€Ğ¾Ñ‚Ğ° ğŸ’—","Ğ—Ğ»Ñ–ÑÑ‚ÑŒ ğŸ˜ˆ","ĞšÑ€Ğ°ÑÑ‚Ğ¸ Ñ‚Ğ¾Ñ€Ñ‚Ğ¸ ğŸ°"], ok:0},
        {q:"ĞŸĞ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ Ğ Ğ¾Ğ½Ğ¸ Ğ´Ğ»Ñ Ğ¡Ğ¾Ñ„Ñ–Ñ—:", a:["Ğ¢Ğ¸ Ğ½ĞµĞ¹Ğ¼Ğ¾Ğ²Ñ–Ñ€Ğ½Ğ° âœ¨","Ğ†Ğ´Ğ¸ Ğ³ĞµÑ‚ÑŒ ğŸ™„","Ğ¢Ğ¾Ñ€Ñ‚Ñƒ Ğ½Ğµ Ğ±ÑƒĞ´Ğµ ğŸ˜­"], ok:0},
        {q:"ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ´Ñ€ÑƒĞ¶Ğ±Ğ¸ #1:", a:["ĞŸÑ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ÑƒĞ²Ğ°Ñ‚Ğ¸ ğŸ«¶","Ğ‘Ğ¸Ñ‚Ğ¸ÑÑ Ñ‰Ğ¾Ğ´Ğ½Ñ ğŸ¥Š","Ğ†Ğ³Ğ½Ğ¾Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¸ ğŸ§Š"], ok:0},
        {q:"ĞšĞ¾Ğ»Ğ¸ Ğ¡Ğ¾Ñ„Ñ–Ñ ÑÑƒĞ¼Ğ½Ğ°, Ğ Ğ¾Ğ½Ğ°â€¦", a:["ĞĞ°Ğ´Ñ–ÑˆĞ»Ğµ Ğ»ÑĞ±Ğ¾Ğ² ğŸ’Œ","Ğ¡Ğ¼Ñ–ÑÑ‚Ğ¸Ğ¼ĞµÑ‚ÑŒÑÑ ğŸ˜­","Ğ—Ğ½Ğ¸ĞºĞ½Ğµ ğŸ«¥"], ok:0},
        {q:"Ğ Ñ–Ğ²ĞµĞ½ÑŒ Ğ´Ñ€ÑƒĞ¶Ğ±Ğ¸:", a:["ĞĞĞ—ĞĞ’Ğ–Ğ”Ğ˜ â™¾ï¸","2 Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½Ğ¸ â³","Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ½ĞµĞ´Ñ–Ğ»ĞºĞ°Ñ… ğŸ¥²"], ok:0},
      ];

      let idx = 0;
      let correct = 0;

      const box = document.createElement("div");
      box.style.maxWidth="760px";
      box.style.margin="0 auto";
      gameStage.appendChild(box);

      function render(){
        const item = qs[idx];
        box.innerHTML = `
          <div class="pill" style="justify-content:center; font-size:14px">
            <span>ğŸ’</span><span style="font-weight:950">${item.q}</span>
          </div>
          <div class="spacer"></div>
          <div class="grid" style="grid-template-columns:1fr; gap:10px">
            ${item.a.map((x,i)=>`<button class="btn">${x}</button>`).join("")}
          </div>
          <div class="spacer"></div>
          <div class="mini muted">Question ${idx+1}/5 â€¢ Correct: ${correct}</div>
        `;
        const buttons = $$("button", box);
        buttons.forEach((b,i)=>{
          b.addEventListener("pointerdown", ()=>{
            if(i===item.ok){
              correct++;
              addScore(10);
              burstConfetti(90);
              sfx.win();
            }else{
              burstConfetti(15);
              sfx.lose();
            }
            idx++;
            if(idx>=qs.length){
              if(correct>=4) winLevel(40,28);
              else loseLevel();
            }else{
              render();
            }
          }, {passive:true});
        });
      }
      render();
    }

    // 7) Hidden hearts
    function game7_hiddenHearts(){
      setHUD({
        hint: state.lang==="EN"
          ? "Find 10 hidden hearts â¤ï¸ Tap them!"
          : "Ğ—Ğ½Ğ°Ğ¹Ğ´Ğ¸ 10 ÑÑ…Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ… ÑĞµÑ€Ğ´ĞµÑ†ÑŒ â¤ï¸ ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹!",
        score, time: 0, msg
      });

      const target = 10;
      let found = 0;

      const info = document.createElement("div");
      info.className="pill";
      info.style.position="absolute";
      info.style.left="12px";
      info.style.bottom="12px";
      info.textContent = `â¤ï¸ ${found}/${target}`;
      gameStage.appendChild(info);

      // decorate background with clickable stars
      for(let i=0;i<18;i++){
        const s = document.createElement("div");
        s.className="bubble";
        s.style.left = rand(2, 92)+"%";
        s.style.top = rand(6, 86)+"%";
        s.style.opacity = .7;
        s.style.fontSize="18px";
        s.textContent = pick(["â­","âœ¨","ğŸŒ¸"]);
        s.addEventListener("pointerdown", ()=>{
          addScore(1);
          burstConfetti(10);
          beep(520,0.03,"sine",0.04);
        }, {passive:true});
        gameStage.appendChild(s);
      }

      startCountdown(22, ()=>{
        if(found>=target) winLevel(35,22);
        else loseLevel();
      });

      for(let i=0;i<target;i++){
        const h = document.createElement("div");
        h.className="bubble heart";
        h.textContent = "â¤ï¸";
        h.style.left = rand(4, 90)+"%";
        h.style.top = rand(10, 82)+"%";
        h.style.opacity = rand(0.2,0.95);
        h.style.transform = `scale(${rand(0.7,1.2)})`;
        h.addEventListener("pointerdown", ()=>{
          found++;
          addScore(6);
          h.remove();
          burstConfetti(30);
          sfx.click();
          info.textContent = `â¤ï¸ ${found}/${target}`;
          if(found>=target){
            if(levelTimer){ clearInterval(levelTimer); levelTimer=null; }
            winLevel(45,28);
          }
        }, {passive:true});
        gameStage.appendChild(h);
      }
    }

    // 8) Whack-a-mole (birthday)
    function game8_whack(){
      setHUD({
        hint: state.lang==="EN"
          ? "Whack cakes/hearts! Tap fast for points ğŸ¯"
          : "Ğ‘Ğ¸Ğ¹ Ñ‚Ğ¾Ñ€Ñ‚Ğ¸/ÑĞµÑ€Ñ†Ñ! ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ ÑˆĞ²Ğ¸Ğ´ĞºĞ¾ ğŸ¯",
        score, time: 0, msg
      });

      const holes = document.createElement("div");
      holes.style.display="grid";
      holes.style.gridTemplateColumns="repeat(3, 1fr)";
      holes.style.gap="10px";
      holes.style.maxWidth="520px";
      holes.style.margin="0 auto";
      holes.style.padding="10px";
      gameStage.appendChild(holes);

      const cells = [];
      for(let i=0;i<9;i++){
        const c = document.createElement("div");
        c.style.aspectRatio="1/1";
        c.style.borderRadius="22px";
        c.style.border="1px solid rgba(0,0,0,.08)";
        c.style.background="rgba(255,255,255,.75)";
        c.style.boxShadow="0 10px 22px rgba(0,0,0,.08)";
        c.style.display="grid";
        c.style.placeItems="center";
        c.style.fontSize="30px";
        c.style.cursor="pointer";
        c.textContent="ğŸ•³ï¸";
        c.addEventListener("pointerdown", ()=>{
          if(c.dataset.active==="1"){
            addScore(5);
            burstConfetti(25);
            beep(860,0.04,"triangle",0.05);
            c.dataset.active="0";
            c.textContent="ğŸ•³ï¸";
          }else{
            addScore(0);
          }
        }, {passive:true});
        holes.appendChild(c);
        cells.push(c);
      }

      startCountdown(18, ()=>{
        if(score>=55) winLevel(40,25);
        else loseLevel();
      });

      const iv = setInterval(()=>{
        const c = pick(cells);
        c.dataset.active="1";
        c.textContent = pick(["ğŸ‚","ğŸ’—","ğŸ°","â­"]);
        setTimeout(()=>{
          if(c.dataset.active==="1"){
            c.dataset.active="0";
            c.textContent="ğŸ•³ï¸";
          }
        }, powerUp.slow ? 900 : 650);
      }, powerUp.slow ? 520 : 420);

      levelCleanup = ()=> clearInterval(iv);
    }

    // 9) Drag & drop puzzle (simple)
    function game9_puzzle(){
      setHUD({
        hint: state.lang==="EN"
          ? "Drag the cake pieces into the slots ğŸ°"
          : "ĞŸĞµÑ€ĞµÑ‚ÑĞ³Ğ½Ğ¸ Ñ‡Ğ°ÑÑ‚Ğ¸Ğ½Ğ¸ Ñ‚Ğ¾Ñ€Ñ‚Ğ° Ñƒ ÑĞ»Ğ¾Ñ‚Ğ¸ ğŸ°",
        score, time: 0, msg
      });

      const pieces = ["ğŸ“","ğŸ«","ğŸ§","ğŸ‚"];
      const shuffled = [...pieces].sort(()=>Math.random()-0.5);
      let placed = 0;

      const wrap = document.createElement("div");
      wrap.style.display="grid";
      wrap.style.gridTemplateColumns="1fr 1fr";
      wrap.style.gap="14px";
      wrap.style.maxWidth="760px";
      wrap.style.margin="0 auto";
      gameStage.appendChild(wrap);

      const left = document.createElement("div");
      left.className="card";
      left.style.background="rgba(255,255,255,.65)";
      left.innerHTML = `<div class="mini muted">Pieces</div>`;
      wrap.appendChild(left);

      const right = document.createElement("div");
      right.className="card";
      right.style.background="rgba(255,255,255,.65)";
      right.innerHTML = `<div class="mini muted">Slots</div>`;
      wrap.appendChild(right);

      const pieceRow = document.createElement("div");
      pieceRow.className="row";
      pieceRow.style.justifyContent="center";
      pieceRow.style.marginTop="10px";
      left.appendChild(pieceRow);

      shuffled.forEach((p)=>{
        const el = document.createElement("div");
        el.className="bubble";
        el.textContent = p;
        el.style.position="relative";
        el.style.left="0"; el.style.top="0";
        el.style.fontSize="28px";
        el.draggable = true;
        el.addEventListener("dragstart", (e)=>{
          e.dataTransfer.setData("text/plain", p);
          beep(620,0.03,"sine",0.04);
        });
        el.addEventListener("pointerdown", ()=>{
          // tap-to-place helper
          const slot = $(".slot.empty", right);
          if(slot){
            slot.textContent = p;
            slot.classList.remove("empty");
            placed++;
            addScore(10);
            burstConfetti(40);
            if(placed===pieces.length) winLevel(45,30);
            el.remove();
          }
        }, {passive:true});
        pieceRow.appendChild(el);
      });

      const slots = document.createElement("div");
      slots.style.display="grid";
      slots.style.gridTemplateColumns="repeat(2, 1fr)";
      slots.style.gap="12px";
      slots.style.marginTop="10px";
      right.appendChild(slots);

      for(let i=0;i<4;i++){
        const s = document.createElement("div");
        s.className="slot empty";
        s.style.aspectRatio="1/1";
        s.style.borderRadius="22px";
        s.style.border="2px dashed rgba(0,0,0,.15)";
        s.style.background="rgba(255,255,255,.55)";
        s.style.display="grid";
        s.style.placeItems="center";
        s.style.fontSize="28px";
        s.textContent = "â¬œ";
        s.addEventListener("dragover", (e)=> e.preventDefault());
        s.addEventListener("drop", (e)=>{
          e.preventDefault();
          if(!s.classList.contains("empty")) return;
          const p = e.dataTransfer.getData("text/plain");
          s.textContent = p;
          s.classList.remove("empty");
          placed++;
          addScore(10);
          burstConfetti(40);
          sfx.click();
          if(placed===pieces.length) winLevel(45,30);
        });
        slots.appendChild(s);
      }
    }

    // 10) Boss monster
    function game10_boss(){
      setHUD({
        hint: state.lang==="EN"
          ? "Boss fight! Tap the monster to defeat it ğŸ˜ˆ Protect the cake ğŸ‚"
          : "Ğ‘Ğ¸Ñ‚Ğ²Ğ° Ğ· Ğ±Ğ¾ÑĞ¾Ğ¼! ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ Ğ½Ğ° Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ° ğŸ˜ˆ Ğ—Ğ°Ñ…Ğ¸ÑÑ‚Ğ¸ Ñ‚Ğ¾Ñ€Ñ‚ ğŸ‚",
        score, time: 0, msg
      });

      let hp = 35;
      const monster = document.createElement("div");
      monster.className="bubble";
      monster.style.left="50%";
      monster.style.top="35%";
      monster.style.transform="translate(-50%,-50%)";
      monster.style.fontSize="54px";
      monster.style.width="140px";
      monster.style.height="140px";
      monster.style.borderRadius="40px";
      monster.textContent="ğŸ˜ˆ";
      gameStage.appendChild(monster);

      const cake = document.createElement("div");
      cake.className="bubble";
      cake.style.left="50%";
      cake.style.top="72%";
      cake.style.transform="translate(-50%,-50%)";
      cake.style.fontSize="44px";
      cake.style.width="120px";
      cake.style.height="90px";
      cake.style.borderRadius="32px";
      cake.textContent="ğŸ‚";
      gameStage.appendChild(cake);

      const hpChip = document.createElement("div");
      hpChip.className="pill";
      hpChip.style.position="absolute";
      hpChip.style.left="12px";
      hpChip.style.top="12px";
      hpChip.textContent = `ğŸ˜ˆ HP: ${hp}`;
      gameStage.appendChild(hpChip);

      startCountdown(20, ()=>{
        if(hp<=0) winLevel(60,40);
        else loseLevel();
      });

      monster.addEventListener("pointerdown", ()=>{
        hp -= powerUp.doubleScore ? 2 : 1;
        addScore(2);
        hpChip.textContent = `ğŸ˜ˆ HP: ${hp}`;
        burstConfetti(20);
        beep(980,0.03,"square",0.05);
        // shake
        monster.style.transform = `translate(-50%,-50%) rotate(${rand(-8,8)}deg) scale(${rand(0.98,1.05)})`;
        setTimeout(()=> monster.style.transform="translate(-50%,-50%)", 120);

        if(hp<=0){
          if(levelTimer){ clearInterval(levelTimer); levelTimer=null; }
          burstConfetti(350);
          sfx.win();
          winLevel(80,55);
        }
      }, {passive:true});

      // cake is clickable surprise
      cake.addEventListener("pointerdown", ()=>{
        burstConfetti(120);
        addReward(10,5);
        popMessage();
      }, {passive:true});

      // random monster attack (screen shake)
      const iv = setInterval(()=>{
        gameStage.style.transform = `translate(${rand(-4,4)}px, ${rand(-4,4)}px)`;
        setTimeout(()=> gameStage.style.transform = "translate(0,0)", 120);
      }, powerUp.slow ? 1200 : 900);

      levelCleanup = ()=> clearInterval(iv);
    }

    // 11) Rhythm tap
    function game11_rhythm(){
      setHUD({
        hint: state.lang==="EN"
          ? "Tap when the beat hits the center ğŸµ"
          : "ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ ĞºĞ¾Ğ»Ğ¸ Ğ±Ñ–Ñ‚ Ğ² Ñ†ĞµĞ½Ñ‚Ñ€Ñ– ğŸµ",
        score, time: 0, msg
      });

      const lane = document.createElement("div");
      lane.style.maxWidth="760px";
      lane.style.margin="0 auto";
      lane.style.height="160px";
      lane.style.borderRadius="26px";
      lane.style.border="1px solid rgba(0,0,0,.08)";
      lane.style.background="rgba(255,255,255,.72)";
      lane.style.position="relative";
      lane.style.overflow="hidden";
      lane.style.boxShadow="0 10px 22px rgba(0,0,0,.08)";
      gameStage.appendChild(lane);

      const center = document.createElement("div");
      center.style.position="absolute";
      center.style.left="50%";
      center.style.top="0";
      center.style.bottom="0";
      center.style.width="10px";
      center.style.transform="translateX(-50%)";
      center.style.background="linear-gradient(180deg, rgba(255,79,179,.0), rgba(255,79,179,.45), rgba(255,79,179,.0))";
      lane.appendChild(center);

      const btn = document.createElement("button");
      btn.className="btn primary";
      btn.style.width="100%";
      btn.style.maxWidth="280px";
      btn.style.margin="12px auto 0 auto";
      btn.textContent = state.lang==="EN" ? "TAP ğŸµ" : "ĞĞĞ¢Ğ˜Ğ¡ĞĞ˜ ğŸµ";
      gameStage.appendChild(btn);

      let x = 0;
      let dir = 1;
      const note = document.createElement("div");
      note.className="bubble";
      note.style.top="50%";
      note.style.transform="translateY(-50%)";
      note.style.left="0%";
      note.style.fontSize="28px";
      note.textContent="ğŸµ";
      lane.appendChild(note);

      startCountdown(18, ()=>{
        if(score>=70) winLevel(50,35);
        else loseLevel();
      });

      const iv = setInterval(()=>{
        x += dir * (powerUp.slow ? 1.6 : 2.4);
        if(x>=96){dir=-1;}
        if(x<=0){dir=1;}
        note.style.left = x+"%";
      }, 16);

      function tap(){
        // center at 50%
        const dist = Math.abs(x-50);
        if(dist<4){
          addScore(18);
          burstConfetti(90);
          sfx.win();
        }else if(dist<10){
          addScore(10);
          burstConfetti(40);
          beep(740,0.04,"triangle",0.05);
        }else{
          burstConfetti(10);
          beep(180,0.06,"sawtooth",0.04);
        }
      }
      btn.addEventListener("pointerdown", tap, {passive:true});
      lane.addEventListener("pointerdown", tap, {passive:true});

      levelCleanup = ()=> clearInterval(iv);
    }

    // 12) Snake mini
    function game12_snake(){
      setHUD({
        hint: state.lang==="EN"
          ? "Snake game! Eat 6 candies ğŸ¬ Use tap arrows."
          : "Ğ—Ğ¼Ñ–Ğ¹ĞºĞ°! Ğ—â€™Ñ—Ğ¶ 6 Ñ†ÑƒĞºĞµÑ€Ğ¾Ğº ğŸ¬ ĞĞ°Ñ‚Ğ¸ÑĞºĞ°Ğ¹ ÑÑ‚Ñ€Ñ–Ğ»ĞºĞ¸.",
        score, time: 0, msg
      });

      const size = 12;
      let snake = [{r:6,c:6}];
      let dir = {r:0,c:1};
      let candy = {r:randi(0,size-1), c:randi(0,size-1)};
      let eaten = 0;
      const target = 6;

      const board = document.createElement("div");
      board.style.display="grid";
      board.style.gridTemplateColumns=`repeat(${size}, 1fr)`;
      board.style.gap="4px";
      board.style.maxWidth="520px";
      board.style.margin="0 auto";
      board.style.padding="10px";
      gameStage.appendChild(board);

      const info = document.createElement("div");
      info.className="pill";
      info.style.position="absolute";
      info.style.left="12px";
      info.style.bottom="12px";
      info.textContent = `ğŸ¬ ${eaten}/${target}`;
      gameStage.appendChild(info);

      const controls = document.createElement("div");
      controls.style.display="grid";
      controls.style.gridTemplateColumns="repeat(3, 1fr)";
      controls.style.gap="10px";
      controls.style.maxWidth="320px";
      controls.style.margin="12px auto 0 auto";
      controls.innerHTML = `
        <div></div><button class="btn small">â¬†ï¸</button><div></div>
        <button class="btn small">â¬…ï¸</button><button class="btn small">â¬‡ï¸</button><button class="btn small">â¡ï¸</button>
      `;
      gameStage.appendChild(controls);
      const b = controls.querySelectorAll("button");
      b[0].addEventListener("pointerdown", ()=> setDir(-1,0), {passive:true});
      b[1].addEventListener("pointerdown", ()=> setDir(0,-1), {passive:true});
      b[2].addEventListener("pointerdown", ()=> setDir(1,0), {passive:true});
      b[3].addEventListener("pointerdown", ()=> setDir(0,1), {passive:true});

      function setDir(r,c){
        // prevent reverse
        if(snake.length>1 && snake[0].r + r === snake[1].r && snake[0].c + c === snake[1].c) return;
        dir = {r,c};
      }

      function draw(){
        board.innerHTML="";
        for(let r=0;r<size;r++){
          for(let c=0;c<size;c++){
            const cell = document.createElement("div");
            cell.style.aspectRatio="1/1";
            cell.style.borderRadius="10px";
            cell.style.border="1px solid rgba(0,0,0,.06)";
            cell.style.background="rgba(255,255,255,.72)";
            // snake
            if(snake.some(p=>p.r===r && p.c===c)){
              cell.style.background="rgba(108,99,255,.22)";
              cell.textContent=" ";
            }
            // head
            if(snake[0].r===r && snake[0].c===c){
              cell.style.background="rgba(255,79,179,.22)";
            }
            // candy
            if(candy.r===r && candy.c===c){
              cell.textContent="ğŸ¬";
              cell.style.fontSize="18px";
              cell.style.display="grid";
              cell.style.placeItems="center";
            }
            // tap cell to steer (simple)
            cell.addEventListener("pointerdown", ()=>{
              const dr = r - snake[0].r;
              const dc = c - snake[0].c;
              if(Math.abs(dr)+Math.abs(dc)===1) setDir(Math.sign(dr), Math.sign(dc));
            }, {passive:true});
            board.appendChild(cell);
          }
        }
      }

      startCountdown(35, ()=>{
        if(eaten>=target) winLevel(60,40);
        else loseLevel();
      });

      const tickMs = powerUp.slow ? 240 : 170;
      const iv = setInterval(()=>{
        const head = snake[0];
        const nh = {r: head.r + dir.r, c: head.c + dir.c};
        if(nh.r<0||nh.c<0||nh.r>=size||nh.c>=size || snake.some(p=>p.r===nh.r && p.c===nh.c)){
          clearInterval(iv);
          loseLevel();
          return;
        }
        snake.unshift(nh);
        if(nh.r===candy.r && nh.c===candy.c){
          eaten++;
          addScore(10);
          burstConfetti(80);
          sfx.win();
          info.textContent = `ğŸ¬ ${eaten}/${target}`;
          // new candy
          do{
            candy = {r:randi(0,size-1), c:randi(0,size-1)};
          }while(snake.some(p=>p.r===candy.r && p.c===candy.c));
          if(eaten>=target){
            clearInterval(iv);
            if(levelTimer){ clearInterval(levelTimer); levelTimer=null; }
            winLevel(80,55);
            return;
          }
        }else{
          snake.pop();
        }
        draw();
      }, tickMs);

      draw();
      levelCleanup = ()=> clearInterval(iv);
    }

    // End of startLevel
  }

  // ---------- Final UI update ----------
  function applyFinalButton(){
    $("#btnToFinal").classList.toggle("disabled", !isAllComplete());
  }

  // ---------- Init & misc ----------
  function init(){
    seedFloating();
    applyAllUI();
    setFairyLine();

    // Loading then welcome
    runLoading();

    // continue button disabled if no save
    const hasSave = !!localStorage.getItem(KEY);
    $("#btnContinue").classList.toggle("disabled", !hasSave);

    // map to final direct
    $("#btnToFinal").addEventListener("pointerdown", ()=>{
      if(!isAllComplete()){
        popMessage();
      }
    }, {passive:true});

    // save when name input changes
    $("#inputName").addEventListener("input", ()=>{
      state.name = $("#inputName").value.trim() || "Sofia";
      saveState();
      applyAllUI();
    });

    // prevent scroll bounce
    document.addEventListener("touchmove", ()=>{}, {passive:true});
  }

  init();
})();
</script>
</body>
</html>
